<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日常火源暨避難設施自行檢查表</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            -webkit-print-color-adjust: exact;
        }

        /* --- 螢幕顯示用 (模擬 A4) --- */
        .page {
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            margin: 10mm auto;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* 表格通用樣式 */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            border: 1px solid #000;
            text-align: center;
            padding: 4px;
            vertical-align: middle;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        /* 輸入框樣式 */
        input[type="text"], textarea {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            background: transparent;
            font-family: inherit;
            resize: none;
            outline: none;
        }

        input[type="text"]:focus, textarea:focus {
            background-color: #eef2ff;
        }

        .holiday-row {
            background-color: #fee2e2;
        }
        
        .instruction-text {
            font-size: 0.75rem; 
            line-height: 1.4;
            text-align: left;
        }

        .disabled-btn {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* --- 列印專用樣式 (確保單頁) --- */
        @media print {
            @page {
                size: A4;
                margin: 0; /* 關鍵：強制移除瀏覽器邊界 */
            }

            body {
                background-color: white;
                margin: 0;
                padding: 0;
            }

            .page {
                width: 210mm;
                height: auto; /* 移除固定高度，避免強制分頁 */
                min-height: auto;
                margin: 0 auto;
                padding: 5mm 8mm; /* 稍微縮減內距 */
                border: none;
                box-shadow: none;
                
                /* 關鍵縮放：縮小至 95% 以容納所有內容於一頁 */
                transform: scale(0.95);
                transform-origin: top center;
                overflow: hidden; /* 防止溢出產生空白頁 */
            }

            .no-print {
                display: none !important;
            }

            /* 壓縮垂直空間 */
            h2 {
                font-size: 14pt;
                margin-bottom: 5px;
                padding-bottom: 2px;
            }

            /* 表格緊湊化 */
            table {
                font-size: 9pt;
            }

            th, td {
                padding: 1px 2px; /* 極小內距，節省垂直空間 */
                height: auto;
                line-height: 1.1;
            }
            
            /* 表頭文字稍微縮小 */
            th.text-xs {
                font-size: 7pt;
                line-height: 1.1;
            }

            /* 縮小輸入框高度 */
            input[type="text"] {
                height: 1.1em;
                font-size: 9pt;
            }

            /* 說明文字縮小 */
            .instruction-text {
                font-size: 7pt;
                line-height: 1.2;
                margin-top: 5px;
                padding: 2px;
            }
            
            /* 隱藏連結網址 */
            a[href]:after {
                content: none;
            }
            
            p { margin: 0; }
        }
    </style>
</head>
<body>

    <!-- 控制面板 (列印時隱藏) -->
    <div class="max-w-4xl mx-auto mt-6 mb-4 p-4 bg-white rounded shadow flex flex-wrap gap-4 items-center justify-between no-print">
        <div class="flex items-center gap-2">
            <h1 class="text-xl font-bold text-gray-700">檢查表產生器</h1>
            <input type="number" id="yearInput" class="border rounded p-1 w-20" min="2020" max="2030">
            <span>年</span>
            <select id="monthInput" class="border rounded p-1">
                <option value="0">1月</option><option value="1">2月</option><option value="2">3月</option>
                <option value="3">4月</option><option value="4">5月</option><option value="5">6月</option>
                <option value="6">7月</option><option value="7">8月</option><option value="8">9月</option>
                <option value="9">10月</option><option value="10">11月</option><option value="11">12月</option>
            </select>
        </div>
        <div class="flex gap-2 items-center flex-wrap">
            <button id="undoBtn" onclick="undo()" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800 text-sm disabled-btn" disabled>上一步</button>
            <button id="redoBtn" onclick="redo()" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800 text-sm disabled-btn" disabled>下一步</button>
            <button onclick="resetData()" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800 text-sm">重置當月</button>
            <button onclick="saveData()" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800 text-sm">儲存</button>
            <button onclick="exportToImage()" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800 text-sm">下載 JPG</button>
            <button onclick="window.print()" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm font-bold">列印 / PDF</button>
        </div>
        <div class="w-full text-xs text-gray-500 mt-1">
            * 提示：點擊「日期/星期」欄位可將該日手動標記為「假日」，點擊表格內容可編輯。
        </div>
    </div>

    <!-- 模擬 A4 紙張區域 -->
    <div id="captureArea" class="page">
        <!-- 標題 -->
        <div class="text-center mb-2">
            <h2 class="text-2xl font-bold border-b-2 border-black inline-block pb-1">日常火源暨避難設施自行檢查表 (每週)</h2>
        </div>

        <!-- 資訊欄 (同一行對齊修正) -->
        <div class="flex items-center justify-between mb-2 text-sm font-bold w-full">
            <div class="flex items-center gap-4">
                <div class="flex items-center">
                    <span class="whitespace-nowrap">實施人員：</span>
                    <input type="text" id="inspectorName" class="border-b border-black w-32 text-center px-1" placeholder="輸入姓名">
                </div>
                <div class="flex items-center">
                    <span class="whitespace-nowrap">負責區域：</span>
                    <input type="text" id="areaName" class="border-b border-black w-48 text-center px-1" value="辦公區域">
                </div>
            </div>
            <div class="flex items-center whitespace-nowrap">
                <span>月份：<span id="displayYear"></span>年 <span id="displayMonth"></span>月</span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th rowspan="2" style="width: 45px;">日期</th>
                    <th rowspan="2" style="width: 35px;">星期</th>
                    <th colspan="3" class="bg-orange-100">日常火源</th>
                    <th colspan="4" class="bg-green-100">避難設施</th>
                    <th rowspan="2" style="width: 80px;">備註<br>(異常處置)</th>
                </tr>
                <tr>
                    <!-- Fire Source Items -->
                    <th class="text-xs">不需使用電器<br>關閉電源及<br>拔除插頭</th>
                    <th class="text-xs">其他可燃物<br>管理</th>
                    <th class="text-xs">電器設備電線<br>外觀及使用<br>情形</th>
                    <!-- Evacuation Items -->
                    <th class="text-xs">入門及門把<br>作動是否正常</th>
                    <th class="text-xs">通道無堆積<br>妨礙緊急出口<br>避難逃生物品</th>
                    <th class="text-xs">逃生標示<br>是否常亮</th>
                    <th class="text-xs">通道有確保<br>必要之寬度<br>(0.8m以上)</th>
                </tr>
            </thead>
            <tbody id="checklistBody">
                <!-- Javascript will populate this -->
            </tbody>
        </table>

        <!-- 頁尾說明 -->
        <div class="mt-2 border border-black p-2 instruction-text">
            <div class="font-bold mb-1">填寫說明:</div>
            
            <div class="font-bold">1. 日常火源</div>
            <div class="pl-2 mb-1">
                (1) 如有異常現象，應立即進行檢修及報告部門主管。<br>
                (2) 用火設備之使用情形除表列項目外，請依實際使用狀況於其他類增列查檢項目，用火設備指電氣工具、能發生燃燒或熱之設備、具產生明火、悶火或具有迅速延燒性能等設備和物品。<br>
                (3) 電器設備配線包括各類電器本身之配線或使用之延長線，需檢查以下情形: 1.電器插頭要插牢，不可過載使用。2.適時檢查電線是否破損。3.使用高功率電器若需離開，一定要關閉電源。4.使用電熱器時，應保持離可燃物一定距離。<br>
                (4) 可燃物管理指溶劑、化學品、油品等應和用火設備或電器保持一定距離。<br>
                (5) 符號說明：“/”→無該項設備、“O”→正常、“△” 立即改善後符合規定、“X”→不正常、無法使用、損壞或未依規定且無法立即改善。
            </div>

            <div class="font-bold">2. 避難設施</div>
            <div class="pl-2 mb-1">
                (1) 符號說明: “O” 正常、“△”→改善中、“X”→不正常、無法使用、無法改善。
            </div>

            <div class="mt-1 font-bold">本資料將留存3年備查。</div>

            <div class="mt-3 flex justify-end items-end gap-4 text-sm">
                <div class="font-bold">部門主管簽章：</div>
                <div class="border-b border-black w-40 h-8"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 狀態管理 ---
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth(); // 0-11
        let manualHolidays = {}; 
        let customValues = {}; 
        
        // --- Undo/Redo 堆疊 ---
        const MAX_HISTORY = 20;
        let undoStack = [];
        let redoStack = [];

        // --- DOM 元素 ---
        const yearInput = document.getElementById('yearInput');
        const monthInput = document.getElementById('monthInput');
        const tbody = document.getElementById('checklistBody');
        const displayYear = document.getElementById('displayYear');
        const displayMonth = document.getElementById('displayMonth');
        const inspectorName = document.getElementById('inspectorName');
        const areaName = document.getElementById('areaName');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');

        // --- 歷史紀錄管理 ---
        function takeSnapshot(clearRedo = true) {
            const currentState = JSON.stringify({ manualHolidays, customValues, currentYear, currentMonth });
            const lastState = undoStack.length > 0 ? JSON.stringify(undoStack[undoStack.length - 1].serializedState) : null;

            if (currentState !== lastState) {
                undoStack.push({
                    serializedState: currentState,
                    state: { 
                        manualHolidays: JSON.parse(JSON.stringify(manualHolidays)),
                        customValues: JSON.parse(JSON.stringify(customValues)) 
                    },
                    year: currentYear,
                    month: currentMonth
                });
                if (undoStack.length > MAX_HISTORY) undoStack.shift();
                if (clearRedo) redoStack = [];
                updateHistoryButtons();
            }
        }

        function applySnapshot(snapshot) {
            manualHolidays = snapshot.state.manualHolidays;
            customValues = snapshot.state.customValues;
            
            if (currentYear !== snapshot.year || currentMonth !== snapshot.month) {
                currentYear = snapshot.year;
                currentMonth = snapshot.month;
                yearInput.value = currentYear;
                monthInput.value = currentMonth;
            }
            
            renderTable();
            saveData(false); 
        }

        function undo() {
            if (undoStack.length <= 1) return;
            const currentState = undoStack.pop();
            redoStack.push(currentState);
            const previousState = undoStack[undoStack.length - 1];
            applySnapshot(previousState);
            updateHistoryButtons();
        }

        function redo() {
            if (redoStack.length === 0) return;
            const nextState = redoStack.pop();
            manualHolidays = nextState.state.manualHolidays;
            customValues = nextState.state.customValues;
            undoStack.push(nextState); 
            if (currentYear !== nextState.year || currentMonth !== nextState.month) {
                currentYear = nextState.year;
                currentMonth = nextState.month;
                yearInput.value = currentYear;
                monthInput.value = currentMonth;
            }
            renderTable();
            saveData(false);
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            undoBtn.disabled = undoStack.length <= 1;
            undoBtn.classList.toggle('disabled-btn', undoStack.length <= 1);
            redoBtn.disabled = redoStack.length === 0;
            redoBtn.classList.toggle('disabled-btn', redoStack.length === 0);
        }

        // --- 初始化 ---
        function init() {
            yearInput.value = currentYear;
            monthInput.value = currentMonth;
            
            yearInput.addEventListener('change', updateTable);
            monthInput.addEventListener('change', updateTable);
            inspectorName.addEventListener('input', () => { saveData(); takeSnapshot(); });
            areaName.addEventListener('input', () => { saveData(); takeSnapshot(); });

            loadData();
            takeSnapshot(false);
            renderTable();
        }

        function updateTable() {
            currentYear = parseInt(yearInput.value);
            currentMonth = parseInt(monthInput.value);
            renderTable();
            saveData(); 
            takeSnapshot();
        }

        // --- 核心邏輯 ---
        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; 
        }

        function getDateKey(date) {
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }

        function isHoliday(date) {
            if (isWeekend(date)) return true;
            const key = getDateKey(date);
            return manualHolidays[key] === true;
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function calculateStatusMap(year, month) {
            const daysInMonth = getDaysInMonth(year, month);
            const statusMap = {}; 
            let lastWorkingDay = -1;

            for (let d = 1; d <= daysInMonth; d++) {
                let date = new Date(year, month, d);
                if (isHoliday(date)) {
                    statusMap[d] = 'REST';
                } else {
                    statusMap[d] = 'NONE';
                    lastWorkingDay = d;
                }
            }

            for (let d = 1; d <= daysInMonth; d++) {
                let date = new Date(year, month, d);
                if (date.getDay() === 5) { // Friday
                    let checkDayCandidate = d;
                    while (checkDayCandidate > 0 && statusMap[checkDayCandidate] === 'REST') {
                        checkDayCandidate--;
                    }
                    if (checkDayCandidate > 0) {
                        statusMap[checkDayCandidate] = 'CHECK';
                    }
                }
            }

            if (lastWorkingDay > 0) {
                statusMap[lastWorkingDay] = 'CHECK';
            }

            return statusMap;
        }

        function toggleHoliday(day) {
            const date = new Date(currentYear, currentMonth, day);
            const key = getDateKey(date);
            if (manualHolidays[key]) {
                delete manualHolidays[key];
            } else {
                manualHolidays[key] = true;
            }
            saveData();
            takeSnapshot();
            renderTable();
        }

        // --- 渲染 ---
        function renderTable() {
            tbody.innerHTML = '';
            displayYear.textContent = currentYear;
            displayMonth.textContent = currentMonth + 1;

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const statusMap = calculateStatusMap(currentYear, currentMonth);
            const weekDays = ['日', '一', '二', '三', '四', '五', '六'];

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(currentYear, currentMonth, d);
                const dayOfWeek = weekDays[date.getDay()];
                const status = statusMap[d];
                const dateKey = getDateKey(date);
                
                const tr = document.createElement('tr');
                if (status === 'REST') {
                    tr.classList.add('holiday-row');
                }

                // 日期
                const tdDate = document.createElement('td');
                tdDate.textContent = d;
                tdDate.className = "cursor-pointer hover:bg-gray-200 select-none";
                tdDate.title = "點擊切換假日";
                tdDate.onclick = () => toggleHoliday(d);
                tr.appendChild(tdDate);

                // 星期
                const tdWeek = document.createElement('td');
                tdWeek.textContent = dayOfWeek;
                tdWeek.className = "cursor-pointer hover:bg-gray-200 select-none";
                tdWeek.onclick = () => toggleHoliday(d);
                if (dayOfWeek === '日' || dayOfWeek === '六' || status === 'REST') {
                    tdWeek.classList.add('text-red-500', 'font-bold');
                }
                tr.appendChild(tdWeek);

                // 檢查項目欄位
                for (let i = 0; i < 7; i++) {
                    const td = document.createElement('td');
                    const cellKey = `${dateKey}-c${i}`;
                    
                    let defaultContent = "";
                    if (status === 'REST') defaultContent = "休";
                    else if (status === 'CHECK') defaultContent = "O";
                    else defaultContent = "-";

                    const userVal = customValues[cellKey];
                    const finalVal = userVal !== undefined ? userVal : defaultContent;

                    const input = document.createElement('input');
                    input.type = "text";
                    input.value = finalVal;
                    
                    if (finalVal === 'O') input.classList.add('font-bold', 'text-green-700', 'text-lg');
                    if (finalVal === '休') input.classList.add('text-gray-400');
                    if (finalVal === 'X') input.classList.add('text-red-600', 'font-bold', 'text-lg');

                    input.onchange = (e) => {
                        customValues[cellKey] = e.target.value;
                        saveData();
                        takeSnapshot();
                        renderTable(); 
                    };

                    td.appendChild(input);
                    tr.appendChild(td);
                }

                // 備註欄
                const tdRemark = document.createElement('td');
                const remarkKey = `${dateKey}-remark`;
                const remarkInput = document.createElement('input');
                remarkInput.type = "text";
                remarkInput.value = customValues[remarkKey] || "";
                remarkInput.onchange = (e) => {
                    customValues[remarkKey] = e.target.value;
                    saveData();
                    takeSnapshot();
                };
                tdRemark.appendChild(remarkInput);
                tr.appendChild(tdRemark);

                tbody.appendChild(tr);
            }
        }

        // --- 儲存與讀取 ---
        function saveData(isUserAction = true) {
            const data = {
                manualHolidays,
                customValues,
                inspector: inspectorName.value,
                area: areaName.value,
                lastYear: currentYear,
                lastMonth: currentMonth
            };
            localStorage.setItem('fireChecklistData', JSON.stringify(data));
            if (isUserAction) takeSnapshot();
        }

        function loadData() {
            const raw = localStorage.getItem('fireChecklistData');
            if (raw) {
                const data = JSON.parse(raw);
                manualHolidays = data.manualHolidays || {};
                customValues = data.customValues || {};
                inspectorName.value = data.inspector || "";
                areaName.value = data.area || "辦公區域";
                if(data.lastYear !== undefined && data.lastMonth !== undefined) {
                    yearInput.value = data.lastYear;
                    monthInput.value = data.lastMonth;
                    currentYear = data.lastYear;
                    currentMonth = data.lastMonth;
                }
            }
        }

        function resetData() {
            if(confirm("確定要清除本月所有的手動修改紀錄嗎？")) {
                const prefix = `${currentYear}-${(currentMonth+1).toString().padStart(2,'0')}`;
                for (let key in customValues) {
                    if (key.startsWith(prefix)) delete customValues[key];
                }
                for (let key in manualHolidays) {
                    if (key.startsWith(prefix)) delete manualHolidays[key];
                }
                saveData();
                takeSnapshot();
                renderTable();
            }
        }

        // --- 匯出 JPG ---
        function exportToImage() {
            const element = document.getElementById('captureArea');
            const inputs = element.querySelectorAll('input');
            inputs.forEach(input => {
                input.setAttribute('data-val', input.value);
                input.setAttribute('value', input.value);
            });

            html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: "#ffffff"
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `檢查表_${currentYear}_${currentMonth+1}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        }

        // 啟動
        init();

    </script>
</body>
</html>
