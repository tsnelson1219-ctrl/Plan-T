<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Plan-T (Cloud v1.4)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f7f9fb; }
        .editable-cell:focus { outline: 2px solid theme('colors.blue.400'); border-color: transparent; box-shadow: 0 0 0 2px theme('colors.blue.200'); }
        .date-cell { min-width: 112px; vertical-align: middle; }
        .new-day-border-top { border-top: 4px solid #000 !important; }
        .thick-border-left { border-left: 2px solid #cbd5e1 !important; }
        .row-controls { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        td.location-cell-wrapper:focus-within .row-controls, td.location-cell-wrapper:hover .row-controls { opacity: 1; pointer-events: auto; }
        .category-popover-menu, .confirmation-popover-menu { position: absolute; z-index: 50; }
        .location-cell-content.bg-white { background-color: white !important; }
        .location-cell-content { transition: background-color 0.3s; }
        .cost-subheader-cell { background-color: theme('colors.blue.100'); padding: 8px; font-size: 0.75rem; font-weight: 500; text-align: left; border-left: 1px solid theme('colors.gray.200'); }
        .sticky-col { position: sticky; left: 0; z-index: 20; box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1); }
        thead .sticky-col { z-index: 30; }
        @media print { .no-print { display: none !important; } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* ç™»å…¥é®ç½©æ¨£å¼ */
        #login-overlay { position: fixed; inset: 0; background: #f7f9fb; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body class="min-h-screen">

    <!-- ç™»å…¥ç•«é¢ (ç¾åœ¨ä½œç‚ºç‹€æ…‹èªªæ˜ç•«é¢) -->
    <div id="login-overlay">
        <h1 class="text-4xl font-extrabold text-blue-700 mb-6 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3">
                <path d="M16 2v20"></path>
                <path d="M2 6h4"></path>
                <path d="M2 10h4"></path>
                <path d="M2 14h4"></path>
                <path d="M2 18h4"></path>
                <rect width="16" height="20" x="4" y="2" rx="2"></rect>
            </svg>
            Plan-T (Cloud)
        </h1>
        
        <!-- è‡ªå‹•ç™»å…¥è¨Šæ¯ -->
        <div id="auth-status-msg" class="text-center p-6 border border-red-200 bg-red-50 rounded-lg shadow-md max-w-lg">
            <div id="auth-spinner" class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p id="auth-text" class="text-gray-600 font-medium mb-3">æ­£åœ¨é€²è¡Œç’°å¢ƒèº«ä»½é©—è­‰ (Firestore å”ä½œæ‰€éœ€)...</p>
            
            <h3 class="text-lg font-bold text-red-700 mb-2">é‡è¦ï¼šé—œæ–¼ Google ç™»å…¥çš„é™åˆ¶</h3>
            <p class="text-sm text-red-600 leading-relaxed text-left">
                æ‚¨çœ‹åˆ°çš„ **<code class="bg-red-100 px-1 rounded">Cross-Origin-Opener-Policy</code>** éŒ¯èª¤æ˜¯ç€è¦½å™¨å®‰å…¨ç­–ç•¥ï¼Œæœƒé˜»æ“‹å½ˆå‡ºå¼ç™»å…¥ã€‚
                <br><br>
                **ç³»çµ±å¿…é ˆä½¿ç”¨ç’°å¢ƒæä¾›çš„æ¬Šæ–é€²è¡Œéœé»˜ç™»å…¥**ï¼Œä»¥å–å¾—æ‚¨å”¯ä¸€çš„ `User ID` ä¾†å•Ÿç”¨é›²ç«¯åŠŸèƒ½ã€‚å¦‚æœé©—è­‰å¤±æ•—ï¼Œæ‡‰ç”¨ç¨‹å¼å°‡ç„¡æ³•å•Ÿå‹•ã€‚
                <br><br>
                **å”ä½œæ–¹å¼ï¼š** è«‹ä½¿ç”¨ç•«é¢å³ä¸Šè§’é¡¯ç¤ºçš„ **User ID** (ä¾‹å¦‚ï¼š<code class="bg-yellow-100 px-1 rounded">User ID: 0000...</code>) ä½œç‚ºå”ä½œé‚€è«‹å°è±¡ã€‚
            </p>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ (ç™»å…¥å¾Œé¡¯ç¤º) -->
    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-6 hidden">
        
        <!-- æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œ -->
        <header class="mb-8 bg-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center relative gap-4">
            <div class="w-full md:w-auto flex justify-start gap-2">
                 <!-- é›²ç«¯å­˜æª”æŒ‰éˆ• -->
                <button onclick="window.openCloudManager()" class="flex items-center gap-2 px-4 py-2 bg-amber-100 text-amber-800 rounded-lg hover:bg-amber-200 transition font-medium border border-amber-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    é›²ç«¯è¡Œç¨‹åº«
                </button>
            </div>
            
            <div class="flex flex-col items-center">
                <h1 class="text-2xl md:text-3xl font-extrabold text-blue-700 tracking-tight flex items-center justify-center">
                    Plan-T (Cloud)
                </h1>
                <span id="sync-status" class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-gray-300"></span> æº–å‚™å°±ç·’
                </span>
            </div>
            
            <div class="w-full md:w-auto flex justify-end items-center gap-3">
                <!-- ä½¿ç”¨è€…è³‡è¨Šèˆ‡ç™»å‡º -->
                <div class="flex items-center gap-2">
                    <img id="user-avatar" src="" alt="User" class="w-8 h-8 rounded-full border border-gray-200">
                    <span id="user-name" class="text-sm font-medium text-gray-700"></span>
                    <button id="logout-btn" class="text-xs text-red-500 hover:text-red-700 border border-red-200 px-2 py-1 rounded">ç™»å‡º</button>
                </div>
            </div>
        </header>

        <!-- è¨Šæ¯/åŠ è¼‰æŒ‡ç¤ºå™¨ -->
        <div id="message-area" class="text-center mb-4 hidden"></div>

        <!-- è¼¸å…¥è¡¨å–®å€å¡Š (å»ºç«‹æ–°è¡Œç¨‹) -->
        <section id="input-form-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">å»ºç«‹æ–°è¡Œç¨‹è¨ˆç•«</h2>
            <form id="plan-form" class="space-y-4">
                <div>
                    <label for="tripName" class="block text-sm font-medium text-gray-700">è¨ˆç•«åç¨±</label>
                    <input type="text" id="tripName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="è¼¸å…¥è¡Œç¨‹æ¨™é¡Œï¼Œä¾‹å¦‚ï¼šæ—¥æœ¬é—œè¥¿äº”æ—¥éŠ">
                </div>
                
                <div class="grid grid-cols-2 gap-4 relative">
                    <!-- èµ·å§‹æ—¥æœŸ -->
                    <div>
                        <label for="startDateDisplay" class="block text-sm font-medium text-gray-700">èµ·å§‹æ—¥æœŸ</label>
                        <div class="relative mt-1">
                            <input type="text" id="startDateDisplay" required class="block w-full rounded-l-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white" placeholder="YYYY/MM/DD" onchange="handleManualDateInput(this.value, 'startDate')">
                            <input type="hidden" id="startDate" name="startDate">
                            <button type="button" class="absolute inset-y-0 right-0 px-3 bg-blue-100 rounded-r-lg border border-l-0 border-gray-300 hover:bg-blue-200 z-10" onclick="showCalendar('startDate')">ğŸ“…</button>
                        </div>
                    </div>
                    <!-- çµæŸæ—¥æœŸ -->
                    <div>
                        <label for="endDateDisplay" class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ</label>
                        <div class="relative mt-1">
                            <input type="text" id="endDateDisplay" required class="block w-full rounded-l-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white" placeholder="YYYY/MM/DD" onchange="handleManualDateInput(this.value, 'endDate')">
                            <input type="hidden" id="endDate" name="endDate">
                            <button type="button" class="absolute inset-y-0 right-0 px-3 bg-blue-100 rounded-r-lg border border-l-0 border-gray-300 hover:bg-blue-200 z-10" onclick="showCalendar('endDate')">ğŸ“…</button>
                        </div>
                    </div>
                    
                    <!-- æ—¥æ›†çµ„ä»¶ (Hidden, using prompt for simplicity in this version) -->
                    <div id="calendar-popover" class="hidden"></div>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="submit" id="generate-button" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                        é–‹å§‹è¦åŠƒ
                    </button>
                </div>
            </form>
        </section>

        <!-- è¡Œç¨‹è¡¨é¡¯ç¤ºå€å¡Š -->
        <section id="itinerary-table-section" class="hidden">
            
            <!-- å·¥å…·åˆ— -->
            <div class="mb-4 flex flex-wrap justify-between items-center gap-2 bg-white p-3 rounded-xl shadow-sm border border-gray-100 no-print">
                <div class="flex gap-2 items-center">
                    <!-- åˆ†äº«æŒ‰éˆ• -->
                    <button onclick="window.openShareModal()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-purple-500 rounded hover:bg-purple-600 shadow-sm transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                        é‚€è«‹å”ä½œè€…
                    </button>
                    <span id="collaborators-count" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full hidden"></span>
                </div>

                <div class="flex gap-2">
                    <button onclick="exportToJPG()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-indigo-500 rounded hover:bg-indigo-600">JPG</button>
                    <button onclick="exportToCSV()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700">CSV</button>
                </div>
            </div>

            <div id="capture-area" class="bg-white rounded-xl shadow-lg p-1">
                <h2 id="current-trip-name" class="text-2xl font-bold my-4 text-gray-800 text-center"></h2>
                <!-- è¡¨æ ¼ -->
                <div class="overflow-x-auto pb-4">
                    <table class="min-w-full divide-y divide-gray-200 table-fixed border-b border-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th rowspan="2" class="w-28 px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase border-r border-gray-200 align-bottom sticky-col bg-blue-50">Date</th>
                                <th rowspan="2" class="w-1/4 px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom">Location</th>
                                <th rowspan="2" class="w-24 px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">Time</th>
                                <th colspan="2" class="w-48 px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase border-b border-gray-200 thick-border-left">Cost</th>
                                <th rowspan="2" class="w-16 px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">OK?</th>
                                <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">Remark</th>
                            </tr>
                            <tr>
                                <th class="w-24 cost-subheader-cell editable-cell thick-border-left" contenteditable="true" data-field="costHeader1" data-header="true">(NTD)</th>
                                <th class="w-24 cost-subheader-cell editable-cell" contenteditable="true" data-field="costHeader2" data-header="true">(å††)</th>
                            </tr>
                        </thead>
                        <tbody id="itinerary-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div class="mt-6 text-center no-print">
                 <button onclick="window.closeCurrentTrip()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">é—œé–‰ç›®å‰è¡Œç¨‹ (å›åˆ°ä¸»é¸å–®)</button>
            </div>
        </section>

        <!-- åŠ è¼‰å‹•ç•« -->
        <div id="loading-spinner" class="hidden text-center p-8 fixed inset-0 bg-white/80 z-[60] flex flex-col justify-center items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p id="loading-text" class="mt-3 text-blue-600 font-medium">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- é›²ç«¯å­˜æª”åˆ—è¡¨ Modal -->
    <div id="cloud-manager-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">é›²ç«¯è¡Œç¨‹åº«</h3>
                <button onclick="window.closeCloudManager()" class="text-gray-500 hover:text-gray-700">âœ•</button>
            </div>
            <div class="p-4 bg-blue-50 text-sm text-gray-600">
                é»æ“Šä¸‹æ–¹åˆ—è¡¨é–‹å•Ÿè¡Œç¨‹ã€‚å”ä½œ ID ç‚ºæ‚¨å³ä¸Šè§’é¡¯ç¤ºçš„ **User ID**ã€‚
            </div>
            <div id="cloud-list" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-50 min-h-[200px]">
                <p class="text-center text-gray-400 mt-10">è¼‰å…¥ä¸­...</p>
            </div>
             <div class="p-4 border-t border-gray-200 bg-white">
                <button onclick="window.closeCloudManager(); document.getElementById('input-form-section').classList.remove('hidden');" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å»ºç«‹æ–°è¡Œç¨‹</button>
            </div>
        </div>
    </div>

    <!-- åˆ†äº« Modal -->
    <div id="share-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">é‚€è«‹å”ä½œè€…</h3>
            <p class="text-sm text-red-600 mb-2 p-2 bg-red-50 border border-red-200 rounded">
                **æ³¨æ„ï¼š** ç”±æ–¼ç„¡æ³•ä½¿ç”¨ Google ç™»å…¥ï¼Œè«‹è¼¸å…¥å°æ–¹çš„ **User ID** (ä¾‹å¦‚ï¼š<code class="bg-red-100 px-1 rounded">0000...</code>)ã€‚ä»–å€‘å¯ä»¥åœ¨è‡ªå·±ç•«é¢å³ä¸Šè§’æ‰¾åˆ°ã€‚
            </p>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="share-id-input" class="flex-1 border border-gray-300 rounded-lg p-2" placeholder="è¼¸å…¥å”ä½œè€…çš„ User ID">
                <button onclick="window.addCollaborator()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">æ–°å¢</button>
            </div>

            <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2">ç›®å‰çš„æˆå“¡ï¼š</h4>
                <ul id="collaborators-list" class="text-sm text-gray-600 space-y-1"></ul>
            </div>

            <div class="text-right">
                <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- é¡åˆ¥/ç¢ºèª Popover -->
    <div id="global-category-popover" class="hidden category-popover-menu w-40 bg-white border border-gray-200 rounded-lg shadow-xl p-1 z-50"></div>
    <div id="global-confirmation-popover" class="hidden confirmation-popover-menu w-32 bg-white border border-gray-200 rounded-lg shadow-xl p-1 z-50"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        // Only need signInWithCustomToken and onAuthStateChanged for authentication
        import { getAuth, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, collection, addDoc, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"; // Import for logging

        // setLogLevel('debug'); // å•Ÿç”¨é™¤éŒ¯æ—¥èªŒ

        // --- Firebase Config ---
        // æ³¨æ„ï¼šé€™è£¡çš„é…ç½®æ‡‰ä¾†è‡ªæ‚¨çš„ç’°å¢ƒè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCQtd1FzIi79nzxBoYUwFMErzSqQ1ql6H8",
            authDomain: "plan-t-18056.firebaseapp.com",
            projectId: "plan-t-18056",
            storageBucket: "plan-t-18056.firebasestorage.app",
            messagingSenderId: "303000679644",
            appId: "1:303000679644:web:d37e006d0eb22921a03019",
            measurementId: "G-GFB5L5LHW5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Define appId and Token using environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Note: initialAuthToken is retrieved later in authenticateUser for robust checking.

        // --- Global State ---
        let currentUser = null;
        let currentTripId = null;
        let currentTripData = null;
        let unsubscribeTrip = null; // Listener detacher

        // --- Auth Logic (Modified for Iframe Environment) ---
        const loginOverlay = document.getElementById('login-overlay');
        const appContainer = document.getElementById('app-container');
        const authText = document.getElementById('auth-text');
        const authSpinner = document.getElementById('auth-spinner');

        const authenticateUser = async () => {
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            // Check if the token is available and non-empty
            if (initialAuthToken && initialAuthToken.length > 0) {
                try {
                    authText.textContent = "æ­£åœ¨ä½¿ç”¨ç’°å¢ƒæ¬Šæ–é€²è¡Œèº«ä»½é©—è­‰...";
                    await signInWithCustomToken(auth, initialAuthToken);
                    authText.textContent = "èº«ä»½é©—è­‰æˆåŠŸã€‚";
                } catch (error) {
                    // Custom Token Mismatch Error reported here
                    console.error("Custom Token Login Failed:", error);
                    // ç”±æ–¼åŒ¿åç™»å…¥è¢«é™åˆ¶ (auth/admin-restricted-operation)ï¼Œæˆ‘å€‘ä¸èƒ½å˜—è©¦ fallbackã€‚
                    authText.textContent = "ç’°å¢ƒæ¬Šæ–é©—è­‰å¤±æ•— (è«‹è¯ç¹«é–‹ç™¼è€…ä¿®å¾©æ­¤éŒ¯èª¤)ã€‚";
                    authSpinner.classList.add('hidden');
                    console.error("è‡´å‘½éŒ¯èª¤ï¼šFirebase å®¢è£½åŒ–æ¬Šæ–ç™»å…¥å¤±æ•—ï¼Œä¸”åŒ¿åç™»å…¥è¢«ç®¡ç†å“¡é™åˆ¶ã€‚æ‡‰ç”¨ç¨‹å¼ç„¡æ³•å•Ÿå‹•ã€‚");
                }
            } else {
                 // The general instruction is to fall back to signInAnonymously if the token is missing.
                 // HOWEVER, based on the error report, signInAnonymously is restricted.
                 authText.textContent = "éŒ¯èª¤ï¼šç¼ºå°‘èº«ä»½é©—è­‰æ¬Šæ–ã€‚ç”±æ–¼åŒ¿åç™»å…¥å—é™ï¼Œç„¡æ³•å•Ÿå‹•ã€‚";
                 authSpinner.classList.add('hidden');
                 console.error("è‡´å‘½éŒ¯èª¤ï¼šç¼ºå°‘åˆå§‹åŒ–æ¬Šæ–ï¼Œæ‡‰ç”¨ç¨‹å¼ç„¡æ³•å•Ÿå‹•ã€‚");
            }
        };

        // Start authentication immediately (MANDATORY for Firestore to work)
        authenticateUser();

        document.getElementById('logout-btn').addEventListener('click', () => {
             if(unsubscribeTrip) unsubscribeTrip();
             signOut(auth);
             location.reload(); // Force reload after signout
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                
                // Hide login overlay and show main app
                loginOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Determine user display name. Use UID snippet since Google name/email is NOT available in token sign-in.
                let userName = `User ID: ${user.uid}`; 
                let userPhoto = user.photoURL;
                
                // If not a full Google user, shorten ID for display and use avatar generator
                if (user.isAnonymous || user.uid) { // Check if user.uid exists (which it should after successful auth)
                    userName = `User ID: ${user.uid.substring(0, 8)}...`;
                    // Display full UID in the header, as requested for collaboration
                    document.getElementById('user-name').textContent = `User ID: ${user.uid}`;
                    userPhoto = `https://ui-avatars.com/api/?name=${user.uid.substring(0, 4)}&background=0D8ABC&color=fff`;
                }

                // Update Header UI
                document.getElementById('user-avatar').src = userPhoto;

                // Load cloud manager right away
                window.openCloudManager();
            } else {
                // If sign out happens, or initial load before auth/failed auth
                currentUser = null;
                // If the app is not fully authenticated after the silent attempt, keep the overlay up
                if (!authSpinner.classList.contains('hidden')) {
                    // This block will execute if authenticateUser failed and hid the spinner, 
                    // or if auth hasn't fully settled. We keep the failure message on screen.
                }
            }
        });

        // --- Firestore Logic ---

        // 1. Create New Trip
        const createNewTrip = async (tripData) => {
            if (!currentUser) { console.error("æœªé©—è­‰ä½¿ç”¨è€…ï¼Œç„¡æ³•å»ºç«‹è¡Œç¨‹ã€‚"); return; }
            const userId = currentUser.uid;
            try {
                const collectionPath = `artifacts/${appId}/public/data/trips`;

                const docRef = await addDoc(collection(db, collectionPath), {
                    ...tripData,
                    ownerId: userId,
                    ownerName: `User ID: ${userId.substring(0, 8)}...`,
                    createdAt: new Date().toISOString(),
                    // Use UID for collaborators array for token/anonymous users
                    collaborators: [userId], 
                    headerData: { costHeader1: '(NTD)', costHeader2: '(å††)' }
                });
                return docRef.id;
            } catch (e) {
                console.error("Error adding document: ", e);
                // Use custom modal instead of alert()
                console.error("å»ºç«‹å¤±æ•—ï¼š" + e.message);
            }
        };

        // 2. Load Trip (Real-time)
        window.loadCloudTrip = (tripId) => {
            if (!currentUser) return;
            if (unsubscribeTrip) unsubscribeTrip(); 
            currentTripId = tripId;
            
            window.closeCloudManager();
            document.getElementById('loading-spinner').classList.remove('hidden');

            const docPath = `artifacts/${appId}/public/data/trips/${tripId}`;
            const tripRef = doc(db, docPath);
            
            const syncEl = document.getElementById('sync-status');
            
            unsubscribeTrip = onSnapshot(tripRef, (doc) => {
                document.getElementById('loading-spinner').classList.add('hidden');
                if (doc.exists()) {
                    currentTripData = doc.data();
                    renderItineraryTable(currentTripData.itinerary || [], currentTripData.tripName);
                    
                    const h1 = document.querySelector('[data-field="costHeader1"]');
                    const h2 = document.querySelector('[data-field="costHeader2"]');
                    if(h1 && currentTripData.headerData) h1.textContent = currentTripData.headerData.costHeader1;
                    if(h2 && currentTripData.headerData) h2.textContent = currentTripData.headerData.costHeader2;

                    updateSyncStatus("å·²åŒæ­¥");
                } else {
                    syncEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span> è¡Œç¨‹å·²åˆªé™¤';
                    console.error("æ­¤è¡Œç¨‹å·²è¢«åˆªé™¤"); 
                    // Give user a moment to see the error, then close
                    setTimeout(window.closeCurrentTrip, 2000); 
                }
            }, (error) => {
                console.error("è®€å–å¤±æ•—ï¼š", error);
                updateSyncStatus("è®€å–å¤±æ•—", "error");
                // Give user a moment to see the error, then close
                setTimeout(window.closeCurrentTrip, 2000); 
            });
        };

        // 3. Update Trip
        const updateCloudTrip = async (newData) => {
            if (!currentTripId || !currentUser) return;
            updateSyncStatus("åŒæ­¥ä¸­...", "pending");
            try {
                const docPath = `artifacts/${appId}/public/data/trips/${currentTripId}`;
                await updateDoc(doc(db, docPath), newData);
                // Status updated by onSnapshot listener
            } catch (e) {
                console.error("å„²å­˜å¤±æ•—ï¼š", e);
                updateSyncStatus("å„²å­˜å¤±æ•—", "error");
            }
        };

        // 4. List User's Trips
        window.openCloudManager = async () => {
            if (!currentUser) return;
            const listContainer = document.getElementById('cloud-list');
            const modal = document.getElementById('cloud-manager-modal');
            modal.classList.remove('hidden');
            listContainer.innerHTML = '<p class="text-center text-gray-400 mt-4">è¼‰å…¥ä¸­...</p>';

            try {
                const collectionPath = `artifacts/${appId}/public/data/trips`;

                // Use UID for collaboration check since email is not available
                const userIdentifier = currentUser.uid;
                // Fetch only trips where the current user's UID is in the collaborators array
                const q = query(collection(db, collectionPath), where("collaborators", "array-contains", userIdentifier));
                // Note: Sorting is done in-memory to avoid Firestore index errors.
                const querySnapshot = await getDocs(q);

                listContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">æ‚¨ç›®å‰æ²’æœ‰é›²ç«¯è¡Œç¨‹ã€‚</p>';
                    return;
                }
                
                // Convert to array for in-memory sorting
                const trips = [];
                querySnapshot.forEach(doc => {
                    trips.push({ id: doc.id, ...doc.data() });
                });

                // Sort trips by creation date (optional, for better UX)
                trips.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                trips.forEach((data) => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center hover:bg-blue-50 cursor-pointer transition';
                    item.onclick = (e) => {
                        if(e.target.closest('.delete-btn')) return;
                        window.loadCloudTrip(data.id);
                    };
                    
                    const isOwner = data.ownerId === currentUser.uid;
                    const deleteBtn = isOwner ? `<button class="delete-btn ml-2 p-2 text-red-400 hover:text-red-600 z-10" onclick="window.deleteCloudTrip('${data.id}', event)">ğŸ—‘ï¸</button>` : '';
                    
                    // Display owner ID snippet
                    const ownerSnippet = data.ownerName || `User ID: ${data.ownerId.substring(0, 8)}...`;


                    item.innerHTML = `
                        <div class="overflow-hidden">
                            <div class="font-bold text-gray-800 truncate">${data.tripName}</div>
                            <div class="text-xs text-gray-500">
                                ${data.startDate} ~ ${data.endDate} <br>
                                æ“æœ‰è€…: ${ownerSnippet}
                            </div>
                        </div>
                        ${deleteBtn}
                    `;
                    listContainer.appendChild(item);
                });

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<p class="text-red-500 text-center">è¼‰å…¥å¤±æ•—</p>';
            }
        };

        window.closeCloudManager = () => {
            document.getElementById('cloud-manager-modal').classList.add('hidden');
        };

        window.deleteCloudTrip = async (id, event) => {
            event.stopPropagation(); // Prevent loading the trip
            // Use custom modal/confirm logic instead of window.confirm
            if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤é›²ç«¯è¡Œç¨‹å—ï¼Ÿ")) { 
                const docPath = `artifacts/${appId}/public/data/trips/${id}`;
                await deleteDoc(doc(db, docPath));
                window.openCloudManager(); 
            }
        };

        window.closeCurrentTrip = () => {
            if (unsubscribeTrip) unsubscribeTrip();
            currentTripId = null;
            document.getElementById('itinerary-table-section').classList.add('hidden');
            document.getElementById('input-form-section').classList.add('hidden');
            window.openCloudManager();
        };

        // --- Collaboration Logic ---
        window.openShareModal = () => {
            document.getElementById('share-modal').classList.remove('hidden');
            const list = document.getElementById('collaborators-list');
            list.innerHTML = '';
            const currentUserId = currentUser.uid;

            if(currentTripData && currentTripData.collaborators) {
                currentTripData.collaborators.forEach(identifier => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    
                    // Owner cannot be removed, and owner is the current user
                    const isOwner = identifier === currentTripData.ownerId;
                    
                    li.innerHTML = `
                        <span>${identifier} ${isOwner ? '(æ“æœ‰è€…)' : ''}</span>
                        ${(!isOwner && identifier !== currentUserId) ? `<button class="text-red-400 hover:text-red-600" onclick="window.removeCollaborator('${identifier}')">ç§»é™¤</button>` : ''}
                    `;
                    list.appendChild(li);
                });
            }
        };

        window.addCollaborator = async () => {
            const identifier = document.getElementById('share-id-input').value.trim();
            if(!identifier) return;
            if(!currentTripId) return;

            if (identifier.length < 8) {
                 console.error("è«‹è¼¸å…¥è‡³å°‘ 8 ä½æ•¸çš„ User ID");
                 return;
            }

            try {
                const docPath = `artifacts/${appId}/public/data/trips/${currentTripId}`;
                await updateDoc(doc(db, docPath), {
                    collaborators: arrayUnion(identifier)
                });
                document.getElementById('share-id-input').value = '';
                // Use custom modal instead of alert()
                console.log(`å·²é‚€è«‹ ${identifier}`); 
                window.openShareModal();
            } catch(e) {
                console.error("é‚€è«‹å¤±æ•—ï¼š", e);
            }
        };
        
        window.removeCollaborator = async (identifier) => {
            if(!currentTripId) return;
            try {
                const docPath = `artifacts/${appId}/public/data/trips/${currentTripId}`;
                await updateDoc(doc(db, docPath), {
                    collaborators: arrayRemove(identifier)
                });
                console.log(`å·²ç§»é™¤ ${identifier}`);
                window.openShareModal();
            } catch(e) {
                console.error("ç§»é™¤å¤±æ•—ï¼š", e);
            }
        };

        // --- UI & Helper Functions ---
        const updateSyncStatus = (text, type='success') => {
            const el = document.getElementById('sync-status');
            let color = type === 'success' ? 'bg-green-400' : (type === 'pending' ? 'bg-yellow-400' : 'bg-red-400');
            el.innerHTML = `<span class="w-2 h-2 rounded-full ${color}"></span> ${text}`;
        };

        const dateToIsoString = (date) => date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
        const isoStringToDate = (iso) => { if(!iso) return null; const p=iso.split(/[-/]/).map(Number); return new Date(p[0],p[1]-1,p[2]); };

        document.getElementById('plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tripName = document.getElementById('tripName').value.trim();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if(!tripName || !start || !end) { console.error("è«‹å¡«å¯«å®Œæ•´"); return; } 

            const itinerary = [];
            let curr = isoStringToDate(start);
            const last = isoStringToDate(end);
            let idx = 0;
            // Loop while curr is less than or equal to last (day by day)
            while(curr.getTime() <= last.getTime()) {
                 itinerary.push({
                    date: dateToIsoString(curr),
                    dayNum: idx + 1,
                    dayOfWeek: ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'][curr.getDay()],
                    location: "", departureTime: "", cost1: "", cost2: "", confirmation: "TBD", remark: "", category: ""
                 });
                 // Need to create a new Date object to avoid modifying the original date in the loop
                 const nextDay = new Date(curr);
                 nextDay.setDate(curr.getDate() + 1);
                 curr = nextDay;
                 idx++;
            }

            document.getElementById('loading-spinner').classList.remove('hidden');
            const newId = await createNewTrip({ tripName, startDate: start, endDate: end, itinerary });
            if(newId) window.loadCloudTrip(newId);
        });

        window.handleCellEdit = (e) => {
            if(!currentTripId || !currentTripData) return;
            const cell = e.target;
            const field = cell.dataset.field;
            const val = cell.textContent.trim();

            if (cell.dataset.header === 'true') {
                 const newHeader = { ...currentTripData.headerData, [field]: val };
                 updateCloudTrip({ headerData: newHeader });
            } else {
                 const idx = parseInt(cell.dataset.index);
                 const newItinerary = [...currentTripData.itinerary];
                 newItinerary[idx][field] = val;
                 updateCloudTrip({ itinerary: newItinerary });
            }
        };
        
        window.selectCategory = (idx, cat) => {
             const newItinerary = [...currentTripData.itinerary];
             newItinerary[idx].category = cat;
             updateCloudTrip({ itinerary: newItinerary });
             document.getElementById('global-category-popover').classList.add('hidden');
        };

        window.selectConfirmation = (idx, status) => {
             const newItinerary = [...currentTripData.itinerary];
             newItinerary[idx].confirmation = status;
             updateCloudTrip({ itinerary: newItinerary });
             document.getElementById('global-confirmation-popover').classList.add('hidden');
        };
        
        window.insertRow = (idx, pos) => {
             const newItinerary = [...currentTripData.itinerary];
             const ref = newItinerary[idx];
             
             // Create a blank row, copying date/day info
             const newRow = {
                date: ref.date,
                dayNum: ref.dayNum,
                dayOfWeek: ref.dayOfWeek,
                location: "", departureTime: "", cost1: "", cost2: "", confirmation: "TBD", remark: "", category: ""
             };

             if (pos === 'before') {
                 newItinerary.splice(idx, 0, newRow);
             } else { // 'after'
                 newItinerary.splice(idx + 1, 0, newRow);
             }
             
             updateCloudTrip({ itinerary: newItinerary });
        };
        
        window.deleteRow = (idx) => {
             if(currentTripData.itinerary.length <= 1) { 
                 console.error("è¡Œç¨‹è‡³å°‘éœ€è¦ä¸€è¡Œ");
                 return;
             }
             const newItinerary = [...currentTripData.itinerary];
             newItinerary.splice(idx, 1);
             updateCloudTrip({ itinerary: newItinerary });
        };

        // --- Render Logic ---
        const renderItineraryTable = (itinerary, tripName) => {
            document.getElementById('itinerary-table-section').classList.remove('hidden');
            document.getElementById('input-form-section').classList.add('hidden');
            document.getElementById('current-trip-name').textContent = tripName;
            
            const tbody = document.getElementById('itinerary-body');
            tbody.innerHTML = '';
            let lastDayNum = 0;
            
            itinerary.forEach((row, index) => {
                const tr = document.createElement('tr');
                const isNewDay = row.dayNum !== lastDayNum;
                lastDayNum = row.dayNum;
                
                tr.className = `hover:bg-gray-50 align-top ${isNewDay ? 'new-day-border-top' : ''}`;

                // Date Cell
                tr.innerHTML += `
                    <td class="px-2 py-3 text-center text-sm font-medium text-gray-700 border-r border-gray-200 sticky-col bg-white date-cell ${isNewDay ? 'new-day-border-top' : ''}">
                        ${isNewDay ? `
                            <div class="font-bold text-base text-blue-600">Day ${row.dayNum}</div>
                            <div class="text-xs text-gray-500">${row.date} (${row.dayOfWeek})</div>
                        ` : ''}
                        <div class="no-print mt-2">
                             <button onclick="window.insertRow(${index}, 'before')" class="text-gray-400 hover:text-blue-500 text-xs px-1">â®</button>
                             <button onclick="window.insertRow(${index}, 'after')" class="text-gray-400 hover:text-blue-500 text-xs px-1">â®Ÿ</button>
                        </div>
                    </td>
                `;
                
                // Location Cell
                tr.innerHTML += `
                    <td class="location-cell-wrapper relative px-3 py-2">
                        <div class="location-cell-content p-1 rounded-lg border border-transparent hover:border-blue-300 transition duration-100 min-h-[40px] editable-cell" contenteditable="true" data-index="${index}" data-field="location" onblur="handleCellEdit(event)">${row.location}</div>
                        
                        <!-- Row Controls (Delete & Category) -->
                        <div class="row-controls absolute top-0 right-0 m-1 flex items-center gap-1 bg-white/90 p-1 rounded-lg shadow border border-gray-200">
                             <button onclick="window.openCategoryPopover(event, ${index}, '${row.category}')" class="p-1 rounded text-xs bg-gray-200 text-gray-700 hover:bg-gray-300">
                                 ${row.category || 'åˆ†é¡'}
                             </button>
                             <button onclick="window.deleteRow(${index})" class="p-1 rounded text-xs bg-red-100 text-red-600 hover:bg-red-200">
                                 âœ•
                             </button>
                        </div>
                    </td>
                `;

                // Time Cell
                tr.innerHTML += `<td class="px-3 py-2 thick-border-left"><div class="p-1 rounded-lg editable-cell min-h-[40px]" contenteditable="true" data-index="${index}" data-field="departureTime" onblur="handleCellEdit(event)">${row.departureTime}</div></td>`;
                
                // Cost 1 Cell
                tr.innerHTML += `<td class="px-3 py-2 thick-border-left"><div class="p-1 rounded-lg editable-cell min-h-[40px]" contenteditable="true" data-index="${index}" data-field="cost1" onblur="handleCellEdit(event)">${row.cost1}</div></td>`;
                
                // Cost 2 Cell
                tr.innerHTML += `<td class="px-3 py-2"><div class="p-1 rounded-lg editable-cell min-h-[40px]" contenteditable="true" data-index="${index}" data-field="cost2" onblur="handleCellEdit(event)">${row.cost2}</div></td>`;
                
                // Confirmation Cell (Dropdown/Button)
                const confClass = row.confirmation === 'YES' ? 'bg-green-100 text-green-700' : (row.confirmation === 'NO' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700');
                tr.innerHTML += `
                    <td class="px-3 py-2 text-center thick-border-left">
                        <button onclick="window.openConfirmationPopover(event, ${index})" class="p-1 rounded-full text-xs font-medium w-full ${confClass}">
                            ${row.confirmation}
                        </button>
                    </td>
                `;

                // Remark Cell
                tr.innerHTML += `<td class="px-3 py-2 thick-border-left"><div class="p-1 rounded-lg editable-cell min-h-[40px]" contenteditable="true" data-index="${index}" data-field="remark" onblur="handleCellEdit(event)">${row.remark}</div></td>`;

                tbody.appendChild(tr);
            });
            
            // Re-attach header handlers for cost titles
            document.querySelectorAll('[data-header="true"]').forEach(el => {
                el.onblur = window.handleCellEdit;
            });
        };

        // --- Popover Handlers ---
        const CATEGORIES = ['äº¤é€š', 'ä½å®¿', 'æ™¯é»', 'è³¼ç‰©', 'é¤é£²', 'å…¶ä»–'];
        const CONFIRMATION_STATUSES = ['YES', 'NO', 'TBD'];
        
        window.openCategoryPopover = (e, idx, currentCat) => {
            e.stopPropagation();
            const pop = document.getElementById('global-category-popover');
            pop.innerHTML = CATEGORIES.map(cat => `
                <button onclick="window.selectCategory(${idx}, '${cat}')" class="w-full text-left px-3 py-1.5 text-sm rounded hover:bg-gray-100 ${cat === currentCat ? 'bg-blue-100 text-blue-700 font-semibold' : ''}">
                    ${cat}
                </button>
            `).join('');

            const rect = e.target.getBoundingClientRect();
            pop.style.top = rect.bottom + 5 + 'px';
            pop.style.left = (rect.left - 130) + 'px';
            pop.classList.remove('hidden');
            document.getElementById('global-confirmation-popover').classList.add('hidden');
        };

        window.openConfirmationPopover = (e, idx) => {
            e.stopPropagation();
            const pop = document.getElementById('global-confirmation-popover');
            pop.innerHTML = CONFIRMATION_STATUSES.map(status => `
                <button onclick="window.selectConfirmation(${idx}, '${status}')" class="w-full text-center px-3 py-1.5 text-sm rounded hover:bg-gray-100">
                    ${status}
                </button>
            `).join('');

            const rect = e.target.getBoundingClientRect();
            pop.style.top = rect.bottom + 5 + 'px';
            pop.style.left = rect.left + 'px';
            pop.classList.remove('hidden');
            document.getElementById('global-category-popover').classList.add('hidden');
        };
        
        // Close popovers on click outside
        document.addEventListener('click', (e) => {
             if(!e.target.closest('button')) {
                 document.getElementById('global-category-popover').classList.add('hidden');
                 document.getElementById('global-confirmation-popover').classList.add('hidden');
             }
        });

        // Calendar Logic (Minimalist)
        window.handleManualDateInput = (val, id) => { document.getElementById(id).value = val.replace(/\//g,'-'); };
        window.showCalendar = (id) => {
             // Use custom modal instead of prompt()
             const val = prompt("è«‹è¼¸å…¥æ—¥æœŸ (YYYY-MM-DD):", document.getElementById(id).value || new Date().toISOString().split('T')[0]);
             if(val) { document.getElementById(id).value = val; document.getElementById(id+'Display').value = val; }
        };

        // Export (Keep original functionality mostly)
        window.exportToJPG = () => { 
            html2canvas(document.getElementById("capture-area"), { useCORS: true }).then(canvas => {
                const a = document.createElement("a"); a.href = canvas.toDataURL("image/jpeg"); a.download = "plan.jpg"; a.click();
            });
        };
        // Use custom modal instead of alert()
        window.exportToCSV = () => {
             let csv = "Date,Day,Location,Time,Cost1,Cost2,OK?,Remark\n";
             currentTripData.itinerary.forEach(row => {
                 const d = row.date.replace(/-/g, '/');
                 const c1 = currentTripData.headerData.costHeader1.replace(/,/g, '');
                 const c2 = currentTripData.headerData.costHeader2.replace(/,/g, '');
                 csv += `${d},${row.dayNum},"${row.location.replace(/"/g, '""')}",${row.departureTime},"${row.cost1}",${row.cost2},${row.confirmation},"${row.remark.replace(/"/g, '""')}"\n`;
             });
             
             const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
             const link = document.createElement("a");
             link.href = URL.createObjectURL(blob);
             link.download = currentTripData.tripName.replace(/ /g, '_') + ".csv";
             link.click();
        };

    </script>
</body>
</html>
