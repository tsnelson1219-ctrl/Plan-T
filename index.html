<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Plan-T (Cloud v1.5 - Google å°ˆç”¨)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f7f9fb; }
        .editable-cell:focus { outline: 2px solid theme('colors.blue.400'); border-color: transparent; box-shadow: 0 0 0 2px theme('colors.blue.200'); }
        .date-cell { min-width: 112px; vertical-align: middle; }
        .new-day-border-top { border-top: 4px solid #000 !important; }
        .thick-border-left { border-left: 2px solid #cbd5e1 !important; }
        .row-controls { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        td.location-cell-wrapper:focus-within .row-controls, td.location-cell-wrapper:hover .row-controls { opacity: 1; pointer-events: auto; }
        .category-popover-menu, .confirmation-popover-menu { position: absolute; z-index: 50; }
        .location-cell-content.bg-white { background-color: white !important; }
        .location-cell-content { transition: background-color 0.3s; }
        .cost-subheader-cell { background-color: theme('colors.blue.100'); padding: 8px; font-size: 0.75rem; font-weight: 500; text-align: left; border-left: 1px solid theme('colors.gray.200'); }
        .sticky-col { position: sticky; left: 0; z-index: 20; box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1); }
        thead .sticky-col { z-index: 30; }
        @media print { .no-print { display: none !important; } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* ç™»å…¥é®ç½©æ¨£å¼ (é è¨­é¡¯ç¤º) */
        #login-overlay { position: fixed; inset: 0; background: #f7f9fb; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body class="min-h-screen">

    <!-- ç™»å…¥/è¼‰å…¥ç•«é¢ (éç™»å…¥ç‹€æ…‹æ™‚é¡¯ç¤º) -->
    <div id="login-overlay">
        <h1 class="text-4xl font-extrabold text-blue-700 mb-10 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3">
                <path d="M16 2v20"></path>
                <path d="M2 6h4"></path>
                <path d="M2 10h4"></path>
                <path d="M2 14h4"></path>
                <path d="M2 18h4"></path>
                <rect width="16" height="20" x="4" y="2" rx="2"></rect>
            </svg>
            Plan-T é›²ç«¯ç‰ˆ
        </h1>
        
        <!-- æ‰‹å‹•ç™»å…¥å€åŸŸ (é è¨­é¡¯ç¤º) -->
        <div id="manual-login-area" class="flex flex-col items-center w-full max-w-sm px-4">
            <div id="error-message-box" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 w-full text-sm text-blue-700">
                è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ä»¥å­˜å–é›²ç«¯è¡Œç¨‹åº«ã€‚
            </div>
            
            <button id="google-login-btn" class="w-full flex justify-center items-center gap-3 px-6 py-3 bg-white border border-gray-300 rounded-lg shadow-md hover:bg-gray-50 transition font-medium text-gray-700 mb-3">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="24" height="24" alt="Google">
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ (æœªç™»å…¥æ™‚éš±è—) -->
    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-6 hidden">
        
        <!-- æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œ -->
        <header class="mb-8 bg-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center relative gap-4">
            <div class="w-full md:w-auto flex justify-start gap-2">
                 <!-- é›²ç«¯å­˜æª”æŒ‰éˆ• -->
                <button onclick="window.openCloudManager()" class="flex items-center gap-2 px-4 py-2 bg-amber-100 text-amber-800 rounded-lg hover:bg-amber-200 transition font-medium border border-amber-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    é›²ç«¯è¡Œç¨‹åº«
                </button>
            </div>
            
            <div class="flex flex-col items-center">
                <h1 class="text-2xl md:text-3xl font-extrabold text-blue-700 tracking-tight flex items-center justify-center">
                    Plan-T (Cloud)
                </h1>
                <span id="sync-status" class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-gray-300"></span> æº–å‚™å°±ç·’
                </span>
            </div>
            
            <div class="w-full md:w-auto flex justify-end items-center gap-3">
                <!-- ä½¿ç”¨è€…è³‡è¨Šèˆ‡ç™»å‡º -->
                <div class="flex items-center gap-2">
                    <div id="user-avatar-placeholder" class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs">User</div>
                    <img id="user-avatar" src="" alt="User" class="w-8 h-8 rounded-full border border-gray-200 hidden">
                    <span id="user-name" class="text-sm font-medium text-gray-700 hidden md:inline"></span>
                    <!-- ç™»å‡ºæŒ‰éˆ•ï¼šç¾åœ¨å§‹çµ‚åœ¨é€™è£¡æº–å‚™å¥½ï¼Œç™»å…¥å¾Œæœƒé¡¯ç¤º -->
                    <button id="logout-btn" class="text-xs text-red-500 hover:text-red-700 border border-red-200 px-2 py-1 rounded hidden">ç™»å‡º</button>
                </div>
            </div>
        </header>

        <!-- è¨Šæ¯/åŠ è¼‰æŒ‡ç¤ºå™¨ -->
        <div id="message-area" class="text-center mb-4 hidden"></div>

        <!-- è¼¸å…¥è¡¨å–®å€å¡Š (å»ºç«‹æ–°è¡Œç¨‹) -->
        <section id="input-form-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">å»ºç«‹æ–°è¡Œç¨‹è¨ˆç•«</h2>
            <form id="plan-form" class="space-y-4">
                <div>
                    <label for="tripName" class="block text-sm font-medium text-gray-700">è¨ˆç•«åç¨±</label>
                    <input type="text" id="tripName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="è¼¸å…¥è¡Œç¨‹æ¨™é¡Œï¼Œä¾‹å¦‚ï¼šæ—¥æœ¬é—œè¥¿äº”æ—¥éŠ">
                </div>
                
                <div class="grid grid-cols-2 gap-4 relative">
                    <!-- èµ·å§‹æ—¥æœŸ -->
                    <div>
                        <label for="startDateDisplay" class="block text-sm font-medium text-gray-700">èµ·å§‹æ—¥æœŸ</label>
                        <div class="relative mt-1">
                            <input type="text" id="startDateDisplay" required class="block w-full rounded-l-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white" placeholder="YYYY/MM/DD" onchange="handleManualDateInput(this.value, 'startDate')">
                            <input type="hidden" id="startDate" name="startDate">
                            <button type="button" class="absolute inset-y-0 right-0 px-3 bg-blue-100 rounded-r-lg border border-l-0 border-gray-300 hover:bg-blue-200 z-10" onclick="showCalendar('startDate')">ğŸ“…</button>
                        </div>
                    </div>
                    <!-- çµæŸæ—¥æœŸ -->
                    <div>
                        <label for="endDateDisplay" class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ</label>
                        <div class="relative mt-1">
                            <input type="text" id="endDateDisplay" required class="block w-full rounded-l-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white" placeholder="YYYY/MM/DD" onchange="handleManualDateInput(this.value, 'endDate')">
                            <input type="hidden" id="endDate" name="endDate">
                            <button type="button" class="absolute inset-y-0 right-0 px-3 bg-blue-100 rounded-r-lg border border-l-0 border-gray-300 hover:bg-blue-200 z-10" onclick="showCalendar('endDate')">ğŸ“…</button>
                        </div>
                    </div>
                    
                    <!-- æ—¥æ›†çµ„ä»¶ (æš«æ™‚ä»¥ prompt æ›¿ä»£) -->
                    <div id="calendar-popover" class="absolute top-full left-0 mt-2 w-full z-20 bg-white border border-gray-200 rounded-xl shadow-2xl p-4 hidden md:w-80 md:left-1/2 md:-translate-x-1/2">
                        <div id="calendar-header" class="flex justify-between items-center mb-4">
                            <button type="button" class="p-2 hover:bg-gray-100 rounded-full" onclick="changeMonth(-1)">â—€</button>
                            <span id="current-month-year" class="font-semibold text-lg"></span>
                            <button type="button" class="p-2 hover:bg-gray-100 rounded-full" onclick="changeMonth(1)">â–¶</button>
                        </div>
                        <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center"></div>
                    </div>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="submit" id="generate-button" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                        é–‹å§‹è¦åŠƒ
                    </button>
                </div>
            </form>
        </section>

        <!-- è¡Œç¨‹è¡¨é¡¯ç¤ºå€å¡Š -->
        <section id="itinerary-table-section" class="hidden">
            
            <!-- å·¥å…·åˆ— -->
            <div class="mb-4 flex flex-wrap justify-between items-center gap-2 bg-white p-3 rounded-xl shadow-sm border border-gray-100 no-print">
                <div class="flex gap-2 items-center">
                    <!-- åˆ†äº«æŒ‰éˆ• -->
                    <button onclick="window.openShareModal()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-purple-500 rounded hover:bg-purple-600 shadow-sm transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                        é‚€è«‹å”ä½œè€…
                    </button>
                    <span id="collaborators-count" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full hidden"></span>
                </div>

                <div class="flex gap-2">
                    <button onclick="exportToJPG()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-indigo-500 rounded hover:bg-indigo-600">JPG</button>
                    <button onclick="exportToCSV()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700">CSV</button>
                </div>
            </div>

            <div id="capture-area" class="bg-white rounded-xl shadow-lg p-1">
                <h2 id="current-trip-name" class="text-2xl font-bold my-4 text-gray-800 text-center"></h2>
                <!-- è¡¨æ ¼ -->
                <div class="overflow-x-auto pb-4">
                    <table class="min-w-full divide-y divide-gray-200 table-fixed border-b border-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th rowspan="2" class="w-28 px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase border-r border-gray-200 align-bottom sticky-col bg-blue-50">Date</th>
                                <th rowspan="2" class="w-1/4 px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom">Location</th>
                                <th rowspan="2" class="w-24 px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">Time</th>
                                <th colspan="2" class="w-48 px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase border-b border-gray-200 thick-border-left">Cost</th>
                                <th rowspan="2" class="w-16 px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">OK?</th>
                                <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">Remark</th>
                            </tr>
                            <tr>
                                <th class="w-24 cost-subheader-cell editable-cell thick-border-left" contenteditable="true" data-field="costHeader1" data-header="true">(NTD)</th>
                                <th class="w-24 cost-subheader-cell editable-cell" contenteditable="true" data-field="costHeader2" data-header="true">(å††)</th>
                            </tr>
                        </thead>
                        <tbody id="itinerary-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div class="mt-6 text-center no-print">
                 <button onclick="window.closeCurrentTrip()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">é—œé–‰ç›®å‰è¡Œç¨‹ (å›åˆ°ä¸»é¸å–®)</button>
            </div>
        </section>

        <!-- åŠ è¼‰å‹•ç•« -->
        <div id="loading-spinner" class="hidden text-center p-8 fixed inset-0 bg-white/80 z-[60] flex flex-col justify-center items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p id="loading-text" class="mt-3 text-blue-600 font-medium">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- é›²ç«¯å­˜æª”åˆ—è¡¨ Modal -->
    <div id="cloud-manager-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">é›²ç«¯è¡Œç¨‹åº«</h3>
                <button onclick="window.closeCloudManager()" class="text-gray-500 hover:text-gray-700">âœ•</button>
            </div>
            <div class="p-4 bg-blue-50 text-sm text-gray-600">
                é»æ“Šä¸‹æ–¹åˆ—è¡¨é–‹å•Ÿè¡Œç¨‹ã€‚æ‚¨å¯ä»¥èˆ‡æœ‹å‹åˆ†äº« ID (æ‚¨çš„ ID: <span id="my-user-id-display" class="font-mono bg-blue-100 px-1 rounded"></span>) ä¾†å”ä½œã€‚
            </div>
            <div id="cloud-list" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-50 min-h-[200px]">
                <p class="text-center text-gray-400 mt-10">è¼‰å…¥ä¸­...</p>
            </div>
             <div class="p-4 border-t border-gray-200 bg-white">
                <button onclick="window.closeCloudManager(); document.getElementById('input-form-section').classList.remove('hidden');" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å»ºç«‹æ–°è¡Œç¨‹</button>
            </div>
        </div>
    </div>

    <!-- åˆ†äº« Modal -->
    <div id="share-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">é‚€è«‹å”ä½œè€…</h3>
            <p class="text-sm text-gray-600 mb-4">è¼¸å…¥å°æ–¹çš„ User ID (è«‹å°æ–¹åœ¨é›²ç«¯è¡Œç¨‹åº«æŸ¥çœ‹ ID)ã€‚</p>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="share-email-input" class="flex-1 border border-gray-300 rounded-lg p-2" placeholder="è¼¸å…¥ User ID">
                <button onclick="window.addCollaborator()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">æ–°å¢</button>
            </div>

            <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2">ç›®å‰çš„æˆå“¡ï¼š</h4>
                <ul id="collaborators-list" class="text-sm text-gray-600 space-y-1"></ul>
            </div>

            <div class="text-right">
                <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- é¡åˆ¥/ç¢ºèª Popover -->
    <div id="global-category-popover" class="hidden category-popover-menu w-40 bg-white border border-gray-200 rounded-lg shadow-xl p-1 z-50"></div>
    <div id="global-confirmation-popover" class="hidden confirmation-popover-menu w-32 bg-white border border-gray-200 rounded-lg shadow-xl p-1 z-50"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        // åªå°å…¥ Google ç™»å…¥å’Œç‹€æ…‹ç›£è½ç›¸é—œçš„å‡½å¼
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, collection, addDoc, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Note: This fallback is often incomplete but required for self-containment.
            apiKey: "AIzaSyCQtd1FzIi79nzxBoYUwFMErzSqQ1ql6H8",
            authDomain: "plan-t-18056.firebaseapp.com",
            projectId: "plan-t-18056",
            storageBucket: "plan-t-18056.firebasestorage.app",
            messagingSenderId: "303000679644",
            appId: "1:303000679644:web:d37e006d0eb22921a03019",
            measurementId: "G-GFB5L5LHW5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Global State ---
        let currentUser = null;
        let currentTripId = null;
        let currentTripData = null;
        let unsubscribeTrip = null; 

        // --- UI References ---
        const loginOverlay = document.getElementById('login-overlay');
        const manualLoginArea = document.getElementById('manual-login-area');
        const errorMessageBox = document.getElementById('error-message-box');
        const appContainer = document.getElementById('app-container');

        // --- Auth Logic ---

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        const showLoginError = (msg) => {
            errorMessageBox.className = "bg-red-50 border border-red-200 rounded-lg p-4 mb-6 w-full text-sm text-red-700";
            errorMessageBox.innerHTML = `<strong>ç™»å…¥ç™¼ç”ŸéŒ¯èª¤ï¼š</strong><br>${msg}`;
        };

        // ç¶å®šæ‰‹å‹• Google ç™»å…¥æŒ‰éˆ•
        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                // ç™»å…¥ä¸­æç¤º
                errorMessageBox.textContent = "æ­£åœ¨å‘¼å« Google ç™»å…¥è¦–çª—...";
                errorMessageBox.className = "bg-yellow-50 border border-yellow-200 text-yellow-700 p-4 mb-6 rounded-lg w-full text-sm";
                
                await signInWithPopup(auth, googleProvider);
                // æˆåŠŸçš„è©± onAuthStateChanged æœƒè™•ç†
            } catch (error) {
                console.error("Google Login Error:", error);
                let msg = error.message;
                
                if (error.code === 'auth/popup-blocked') {
                    msg = "ç€è¦½å™¨é˜»æ“‹äº†ç™»å…¥è¦–çª—ã€‚è«‹æª¢æŸ¥å½ˆè·³è¦–çª—è¨­å®šï¼Œæˆ–å˜—è©¦é‡æ–°æ•´ç†é é¢ã€‚";
                } else if (error.code === 'auth/cancelled-popup-request') {
                     msg = "ç™»å…¥å·²è¢«å–æ¶ˆã€‚è«‹é‡æ–°é»æ“Šç™»å…¥ã€‚";
                } else if (error.code === 'auth/operation-not-allowed') {
                     msg = "è«‹ç¢ºèªæ‚¨åœ¨ Firebase Console çš„ Authentication > Sign-in method ä¸­å·²é–‹å•Ÿ <strong>Google ç™»å…¥</strong>ã€‚";
                } else if (error.code === 'auth/network-request-failed') {
                    msg = "ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯ã€‚";
                }

                showLoginError(msg);
            }
        });

        // ç™»å‡ºæŒ‰éˆ•
        document.getElementById('logout-btn').addEventListener('click', () => {
             if(unsubscribeTrip) unsubscribeTrip(); // å–æ¶ˆå°ç•¶å‰è¡Œç¨‹çš„ç›£è½
             signOut(auth).then(() => {
                // ç™»å‡ºæˆåŠŸå¾Œé‡æ–°æ•´ç†é é¢ï¼Œé¡¯ç¤ºç™»å…¥ç•«é¢
                location.reload();
             }).catch(error => {
                 console.error("Logout Error:", error);
                 alert("ç™»å‡ºå¤±æ•—: " + error.message);
             });
        });

        // ç›£è½ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // --- å·²ç™»å…¥ ---
                console.log("--- ç™»å…¥æˆåŠŸï¼---", user.uid, "Provider:", user.providerData[0]?.providerId);
                
                currentUser = user;
                loginOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // æ›´æ–°é ­éƒ¨ UI
                const userNameDisplay = user.displayName || "ä½¿ç”¨è€… " + user.uid.substring(0, 8);
                document.getElementById('user-name').textContent = userNameDisplay;
                document.getElementById('user-name').classList.remove('hidden');
                
                // ç™»å‡ºæŒ‰éˆ•å§‹çµ‚é¡¯ç¤ºçµ¦å·²ç™»å…¥ç”¨æˆ¶
                document.getElementById('logout-btn').classList.remove('hidden');

                if (user.photoURL) {
                    document.getElementById('user-avatar').src = user.photoURL;
                    document.getElementById('user-avatar').classList.remove('hidden');
                    document.getElementById('user-avatar-placeholder').classList.add('hidden');
                } else {
                    document.getElementById('user-avatar-placeholder').textContent = (user.displayName || "U")[0].toUpperCase();
                    document.getElementById('user-avatar').classList.add('hidden');
                    document.getElementById('user-avatar-placeholder').classList.remove('hidden');
                }

                // è¼‰å…¥è¡Œç¨‹åº«
                window.openCloudManager();
            } else {
                // --- æœªç™»å…¥/å·²ç™»å‡º ---
                console.log("Logged Out / Not Signed In");
                currentUser = null;
                // ç¢ºä¿ç™»å…¥ä»‹é¢é¡¯ç¤ºï¼Œä¸»æ‡‰ç”¨ç¨‹å¼éš±è—
                loginOverlay.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        // --- Firestore Logic ---

        // 1. Create New Trip
        const createNewTrip = async (tripData) => {
            if(!currentUser) { alert("è«‹å…ˆç™»å…¥ï¼"); return null; }
            try {
                const collectionPath = `artifacts/${appId}/public/data/trips`;

                const docRef = await addDoc(collection(db, collectionPath), {
                    ...tripData,
                    ownerId: currentUser.uid,
                    ownerName: currentUser.displayName || "Google User", 
                    createdAt: new Date().toISOString(),
                    collaborators: [currentUser.uid], 
                    headerData: { costHeader1: '(NTD)', costHeader2: '(å††)' }
                });
                return docRef.id;
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("å»ºç«‹å¤±æ•—ï¼š" + e.message);
            }
        };

        // 2. Load Trip (Real-time)
        window.loadCloudTrip = (tripId) => {
            if (!currentUser) { alert("è«‹å…ˆç™»å…¥ï¼"); return; }
            if (unsubscribeTrip) unsubscribeTrip(); 
            currentTripId = tripId;
            
            window.closeCloudManager();
            document.getElementById('loading-spinner').classList.remove('hidden');

            const docPath = `artifacts/${appId}/public/data/trips/${tripId}`;
            const tripRef = doc(db, docPath);
            
            unsubscribeTrip = onSnapshot(tripRef, (doc) => {
                document.getElementById('loading-spinner').classList.add('hidden');
                if (doc.exists()) {
                    currentTripData = doc.data();
                    renderItineraryTable(currentTripData.itinerary || [], currentTripData.tripName);
                    
                    const h1 = document.querySelector('[data-field="costHeader1"]');
                    const h2 = document.querySelector('[data-field="costHeader2"]');
                    if(h1 && currentTripData.headerData) h1.textContent = currentTripData.headerData.costHeader1;
                    if(h2 && currentTripData.headerData) h2.textContent = currentTripData.headerData.costHeader2;

                    updateSyncStatus("å·²åŒæ­¥");
                } else {
                    alert("æ­¤è¡Œç¨‹å·²è¢«åˆªé™¤"); 
                    window.closeCurrentTrip();
                }
            }, (error) => {
                console.error(error);
                alert("è®€å–å¤±æ•—ï¼Œæ‚¨å¯èƒ½æ²’æœ‰æ¬Šé™ã€‚"); 
                window.closeCurrentTrip();
            });
        };

        // 3. Update Trip
        const updateCloudTrip = async (newData, merge = true) => {
            if (!currentUser || !currentTripId) return;
            updateSyncStatus("åŒæ­¥ä¸­...", "pending");
            try {
                const docPath = `artifacts/${appId}/public/data/trips/${currentTripId}`;
                const tripRef = doc(db, docPath);
                await updateDoc(tripRef, newData);
                updateSyncStatus("å·²å„²å­˜");
            } catch (e) {
                console.error(e);
                updateSyncStatus("å„²å­˜å¤±æ•—", "error");
            }
        };

        // 4. List User's Trips
        window.openCloudManager = async () => {
            if (!currentUser) { alert("è«‹å…ˆç™»å…¥ï¼"); return; }
            const listContainer = document.getElementById('cloud-list');
            const modal = document.getElementById('cloud-manager-modal');
            const userIdDisplay = document.getElementById('my-user-id-display');
            
            userIdDisplay.textContent = currentUser.uid;

            modal.classList.remove('hidden');
            listContainer.innerHTML = '<p class="text-center text-gray-400 mt-4">è¼‰å…¥ä¸­...</p>';

            try {
                const collectionPath = `artifacts/${appId}/public/data/trips`;

                // åªæŸ¥è©¢å”ä½œè€…åˆ—è¡¨ä¸­åŒ…å«ç•¶å‰ç”¨æˆ¶ ID çš„è¡Œç¨‹
                const q = query(collection(db, collectionPath), where("collaborators", "array-contains", currentUser.uid));
                const querySnapshot = await getDocs(q);

                listContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">æ‚¨ç›®å‰æ²’æœ‰é›²ç«¯è¡Œç¨‹ã€‚</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center hover:bg-blue-50 cursor-pointer transition';
                    item.onclick = (e) => {
                        if(e.target.closest('.delete-btn')) return;
                        window.loadCloudTrip(doc.id);
                    };
                    
                    const isOwner = data.ownerId === currentUser.uid;
                    const deleteBtn = isOwner ? `<button class="delete-btn ml-2 p-2 text-red-400 hover:text-red-600 z-10" onclick="window.deleteCloudTrip('${doc.id}')">ğŸ—‘ï¸</button>` : '';

                    item.innerHTML = `
                        <div class="overflow-hidden">
                            <div class="font-bold text-gray-800 truncate">${data.tripName}</div>
                            <div class="text-xs text-gray-500">
                                ${data.startDate} ~ ${data.endDate} <br>
                                æ“æœ‰è€…: ${isOwner ? 'æˆ‘' : (data.ownerName || 'æœªçŸ¥')}
                            </div>
                        </div>
                        ${deleteBtn}
                    `;
                    listContainer.appendChild(item);
                });

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = `<p class="text-red-500 text-center">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
            }
        };

        window.closeCloudManager = () => {
            document.getElementById('cloud-manager-modal').classList.add('hidden');
        };

        window.deleteCloudTrip = async (id) => {
            if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤é›²ç«¯è¡Œç¨‹å—ï¼Ÿ")) { 
                const docPath = `artifacts/${appId}/public/data/trips/${id}`;
                await deleteDoc(doc(db, docPath));
                window.openCloudManager(); 
            }
        };

        window.closeCurrentTrip = () => {
            if (unsubscribeTrip) unsubscribeTrip();
            currentTripId = null;
            document.getElementById('itinerary-table-section').classList.add('hidden');
            document.getElementById('input-form-section').classList.add('hidden');
            window.openCloudManager();
        };

        // --- Collaboration Logic ---
        window.openShareModal = () => {
            if (!currentUser || !currentTripId) { alert("è«‹å…ˆç™»å…¥ä¸¦é–‹å•Ÿè¡Œç¨‹ï¼"); return; }
            document.getElementById('share-modal').classList.remove('hidden');
            const list = document.getElementById('collaborators-list');
            list.innerHTML = '';
            if(currentTripData && currentTripData.collaborators) {
                currentTripData.collaborators.forEach(uid => {
                    const li = document.createElement('li');
                    li.textContent = uid === currentUser.uid ? `${uid} (æˆ‘)` : uid;
                    list.appendChild(li);
                });
            }
        };

        window.addCollaborator = async () => {
            if (!currentUser || !currentTripId) { alert("è«‹å…ˆç™»å…¥ä¸¦é–‹å•Ÿè¡Œç¨‹ï¼"); return; }
            const targetUid = document.getElementById('share-email-input').value.trim();
            if(!targetUid) return;

            try {
                const docPath = `artifacts/${appId}/public/data/trips/${currentTripId}`;

                await updateDoc(doc(db, docPath), {
                    collaborators: arrayUnion(targetUid)
                });
                document.getElementById('share-email-input').value = '';
                alert(`å·²é‚€è«‹ UID: ${targetUid}`); 
                window.openShareModal(); 
            } catch(e) {
                alert("é‚€è«‹å¤±æ•—");
            }
        };

        // --- UI & Helper Functions ---
        const updateSyncStatus = (text, type='success') => {
            const el = document.getElementById('sync-status');
            let color = type === 'success' ? 'bg-green-400' : (type === 'pending' ? 'bg-yellow-400' : 'bg-red-400');
            el.innerHTML = `<span class="w-2 h-2 rounded-full ${color} animate-pulse"></span> ${text}`;
        };

        const dateToIsoString = (date) => date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
        const isoStringToDate = (iso) => { if(!iso) return null; const p=iso.split(/[-/]/).map(Number); return new Date(p[0],p[1]-1,p[2]); };

        document.getElementById('plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) { alert("è«‹å…ˆç™»å…¥ï¼"); return; }
            const tripName = document.getElementById('tripName').value.trim();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if(!tripName || !start || !end) return alert("è«‹å¡«å¯«å®Œæ•´"); 

            const itinerary = [];
            let curr = isoStringToDate(start);
            const last = isoStringToDate(end);
            let idx = 0;
            while(curr <= last) {
                 itinerary.push({
                    date: dateToIsoString(curr),
                    dayNum: idx + 1,
                    dayOfWeek: ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'][curr.getDay()],
                    location: "", departureTime: "", cost1: "", cost2: "", confirmation: "TBD", remark: "", category: ""
                 });
                 // é¿å…ä¿®æ”¹åŸå§‹ Date ç‰©ä»¶
                 const nextDay = new Date(curr);
                 nextDay.setDate(curr.getDate() + 1);
                 curr = nextDay;
                 idx++;
            }

            document.getElementById('loading-spinner').classList.remove('hidden');
            const newId = await createNewTrip({ tripName, startDate: start, endDate: end, itinerary });
            
            if(newId) window.loadCloudTrip(newId);
        });

        window.handleCellEdit = (e) => {
            if(!currentTripId || !currentTripData) return;
            const cell = e.target;
            const field = cell.dataset.field;
            const val = cell.textContent.trim();

            if (cell.dataset.header === 'true') {
                 const newHeader = { ...currentTripData.headerData, [field]: val };
                 updateCloudTrip({ headerData: newHeader });
            } else {
                 const idx = parseInt(cell.dataset.index);
                 const newItinerary = [...currentTripData.itinerary];
                 newItinerary[idx][field] = val;
                 updateCloudTrip({ itinerary: newItinerary });
            }
        };
        
        window.selectCategory = (idx, cat) => {
             const newItinerary = [...currentTripData.itinerary];
             newItinerary[idx].category = cat;
             updateCloudTrip({ itinerary: newItinerary });
             document.getElementById('global-category-popover').classList.add('hidden');
        };

        window.selectConfirmation = (idx, status) => {
             const newItinerary = [...currentTripData.itinerary];
             newItinerary[idx].confirmation = status;
             updateCloudTrip({ itinerary: newItinerary });
             document.getElementById('global-confirmation-popover').classList.add('hidden');
        };
        
        window.insertRow = (idx, pos) => {
             const newItinerary = [...currentTripData.itinerary];
             const ref = newItinerary[idx];
             // ç¹¼æ‰¿æ—¥æœŸè³‡è¨Šï¼Œä½†æ¸…ç©ºå…§å®¹
             const item = { date: ref.date, dayNum: ref.dayNum, dayOfWeek: ref.dayOfWeek, location:"", departureTime:"", cost1:"", cost2:"", confirmation:"TBD", remark:"", category:"" };
             if(pos === 'before') newItinerary.splice(idx, 0, item);
             else newItinerary.splice(idx+1, 0, item);
             updateCloudTrip({ itinerary: newItinerary });
        };
        
        window.deleteRow = (idx) => {
            if(confirm("åˆªé™¤æ­¤åˆ—?")) { 
                const newItinerary = [...currentTripData.itinerary];
                newItinerary.splice(idx, 1);
                updateCloudTrip({ itinerary: newItinerary });
            }
        };

        const CATEGORY_MAP = { "é‡é»": { class: "bg-lime-200" }, "äº¤é€š": { class: "bg-yellow-100" }, "æ´»å‹•å€": { class: "bg-green-100" }, "äº‹ä»¶": { class: "bg-blue-100" } };
        const CONFIRMATION_MAP = { "O": { symbol: "âœ”", class: "bg-green-500 text-white" }, "X": { symbol: "âœ˜", class: "bg-red-500 text-white" }, "TBD": { symbol: "â–³", class: "bg-yellow-400 text-gray-800" } };

        const renderItineraryTable = (itinerary, tripName) => {
            document.getElementById('input-form-section').classList.add('hidden');
            document.getElementById('itinerary-table-section').classList.remove('hidden');
            document.getElementById('current-trip-name').textContent = tripName;

            const tbody = document.getElementById('itinerary-body');
            tbody.innerHTML = '';
            
            const processedDates = new Set();
            const rowspans = {};
            itinerary.forEach(i => { if(!rowspans[i.date]) rowspans[i.date]=0; rowspans[i.date]++; });

            itinerary.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°çš„ä¸€å¤© (ä¸”ä¸æ˜¯ç¬¬ä¸€è¡Œ) ä¾†æ·»åŠ åˆ†éš”ç·š
                if (!processedDates.has(item.date) && index > 0) tr.classList.add('new-day-border-top');
                
                // è™•ç†æ—¥æœŸ/Day Cell (åˆä½µå„²å­˜æ ¼)
                if (!processedDates.has(item.date)) {
                    tr.innerHTML += `<td rowspan="${rowspans[item.date]}" class="date-cell px-2 py-4 text-sm font-medium text-center border-r border-gray-200 bg-white sticky-col">${item.date.slice(5)}<br>${item.dayOfWeek}<br>(Day ${item.dayNum})</td>`;
                    processedDates.add(item.date);
                }

                const catClass = CATEGORY_MAP[item.category]?.class || 'bg-white';
                const conf = CONFIRMATION_MAP[item.confirmation] || CONFIRMATION_MAP["TBD"];

                tr.innerHTML += `
                    <td class="px-3 py-4 text-sm relative location-cell-wrapper group">
                         <div class="absolute left-1 top-1/2 -translate-y-1/2 flex flex-col gap-1 row-controls z-10">
                            <button onclick="window.insertRow(${index}, 'before')" class="text-blue-600 bg-blue-100 p-1 rounded hover:bg-blue-300 transition">â–²</button>
                            <button onclick="window.insertRow(${index}, 'after')" class="text-blue-600 bg-blue-100 p-1 rounded hover:bg-blue-300 transition">â–¼</button>
                        </div>
                        <div class="flex items-start">
                            <div class="editable-cell flex-grow pl-6 p-2 border border-gray-300 rounded min-h-[2.5rem] ${catClass}" contenteditable="true" data-field="location" data-index="${index}">${item.location}</div>
                            <button onclick="window.showCategoryMenu(${index}, this)" class="ml-1 p-1 bg-gray-100 rounded-full hover:bg-blue-200" title="åˆ†é¡">ğŸ·ï¸</button>
                            <button onclick="window.deleteRow(${index})" class="ml-1 p-1 bg-red-50 text-red-400 rounded-full hover:bg-red-200 transition" title="åˆªé™¤æ­¤è¡Œ">âœ•</button>
                        </div>
                    </td>
                    <td class="px-3 py-4 text-sm thick-border-left"><div class="editable-cell p-2 border rounded bg-white" contenteditable="true" data-field="departureTime" data-index="${index}">${item.departureTime}</div></td>
                    <td class="px-3 py-4 text-sm w-24 thick-border-left"><div class="editable-cell p-2 border rounded bg-white" contenteditable="true" data-field="cost1" data-index="${index}">${item.cost1}</div></td>
                    <td class="px-3 py-4 text-sm w-24"><div class="editable-cell p-2 border rounded bg-white" contenteditable="true" data-field="cost2" data-index="${index}">${item.cost2}</div></td>
                    <td class="px-3 py-4 text-center w-16 thick-border-left"><button onclick="window.showConfirmationMenu(${index}, this)" class="w-full h-8 font-bold rounded ${conf.class}">${conf.symbol}</button></td>
                    <td class="px-3 py-4 text-sm thick-border-left"><div class="editable-cell p-2 border rounded bg-white" contenteditable="true" data-field="remark" data-index="${index}">${item.remark}</div></td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('blur', window.handleCellEdit);
            });
        };

        window.showCategoryMenu = (idx, btn) => {
            const pop = document.getElementById('global-category-popover');
            pop.innerHTML = Object.entries(CATEGORY_MAP).map(([k,v]) => `<button onclick="window.selectCategory(${idx}, '${k}')" class="w-full text-left px-4 py-2 hover:opacity-80 ${v.class}">${k}</button>`).join('') + `<button onclick="window.selectCategory(${idx}, '')" class="w-full text-left px-4 py-2 text-red-500 hover:bg-red-50">æ¸…é™¤</button>`;
            const rect = btn.getBoundingClientRect();
            pop.style.top = (rect.top + window.scrollY) + 'px'; pop.style.left = (rect.right + 10) + 'px';
            pop.classList.remove('hidden');
        };

        window.showConfirmationMenu = (idx, btn) => {
            const pop = document.getElementById('global-confirmation-popover');
            pop.innerHTML = Object.entries(CONFIRMATION_MAP).map(([k,v]) => `<button onclick="window.selectConfirmation(${idx}, '${k}')" class="w-full text-left px-4 py-2 hover:bg-gray-100 ${v.class}">${v.symbol} ${k}</button>`).join('');
            const rect = btn.getBoundingClientRect();
            pop.style.top = (rect.top + window.scrollY) + 'px'; pop.style.left = (rect.left - 130) + 'px';
            pop.classList.remove('hidden');
        };
        
        document.addEventListener('click', (e) => {
             // é»æ“ŠéæŒ‰éˆ•å€åŸŸæ™‚éš±è—å½ˆçª—
             if(!e.target.closest('button')) {
                 document.getElementById('global-category-popover').classList.add('hidden');
                 document.getElementById('global-confirmation-popover').classList.add('hidden');
             }
        });

        window.handleManualDateInput = (val, id) => { document.getElementById(id).value = val.replace(/\//g,'-'); };
        
        // ç‚ºäº†é¿å…ä½¿ç”¨ alert/promptï¼Œé€™è£¡ä½¿ç”¨ç€è¦½å™¨å…§å»ºçš„ confirm/promptï¼Œä½†æœ€å¥½åœ¨æ­£å¼ç’°å¢ƒä½¿ç”¨ Modal
        window.showCalendar = (id) => { 
             const val = prompt("è«‹è¼¸å…¥æ—¥æœŸ (YYYY-MM-DD):", document.getElementById(id).value || new Date().toISOString().split('T')[0]);
             if(val) { document.getElementById(id).value = val; document.getElementById(id+'Display').value = val; }
        };

        window.exportToJPG = () => { 
            html2canvas(document.getElementById("capture-area"), { useCORS: true }).then(canvas => {
                const a = document.createElement("a"); a.href = canvas.toDataURL("image/jpeg"); a.download = "plan.jpg"; a.click();
            });
        };
        // ç‚ºäº†é¿å…ä½¿ç”¨ alert()ï¼Œé€™è£¡ä½¿ç”¨ç€è¦½å™¨å…§å»ºçš„ confirm()
        window.exportToCSV = () => { confirm("CSV åŠŸèƒ½åœ¨é›²ç«¯ç‰ˆä¸­æš«æ™‚éš±è—ï¼Œæ‚¨ç¢ºå®šè¦åŒ¯å‡ºå—ï¼Ÿ"); }; 

    </script>
</body>
</html>
