<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Plan-T (Cloud v1.6)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f7f9fb; }
        .editable-cell:focus { outline: 2px solid theme('colors.blue.400'); border-color: transparent; box-shadow: 0 0 0 2px theme('colors.blue.200'); }
        .date-cell { min-width: 112px; vertical-align: middle; }
        .new-day-border-top { border-top: 4px solid #000 !important; }
        .thick-border-left { border-left: 2px solid #cbd5e1 !important; }
        .row-controls { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        td.location-cell-wrapper:focus-within .row-controls, td.location-cell-wrapper:hover .row-controls { opacity: 1; pointer-events: auto; }
        .category-popover-menu, .confirmation-popover-menu { position: absolute; z-index: 50; }
        .location-cell-content.bg-white { background-color: white !important; }
        .location-cell-content { transition: background-color 0.3s; }
        .cost-subheader-cell { background-color: theme('colors.blue.100'); padding: 8px; font-size: 0.75rem; font-weight: 500; text-align: left; border-left: 1px solid theme('colors.gray.200'); }
        .sticky-col { position: sticky; left: 0; z-index: 20; box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1); }
        thead .sticky-col { z-index: 30; }
        @media print { .no-print { display: none !important; } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* ç™»å…¥é®ç½©æ¨£å¼ */
        #login-overlay { position: fixed; inset: 0; background: #f7f9fb; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        /* é™¤éŒ¯å€å¡Š */
        #debug-console { max-height: 150px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body class="min-h-screen">

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-overlay">
        <h1 class="text-4xl font-extrabold text-blue-700 mb-6 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3">
                <path d="M16 2v20"></path>
                <path d="M2 6h4"></path>
                <path d="M2 10h4"></path>
                <path d="M2 14h4"></path>
                <path d="M2 18h4"></path>
                <rect width="16" height="20" x="4" y="2" rx="2"></rect>
            </svg>
            Plan-T é›²ç«¯ç‰ˆ
        </h1>
        <p class="text-gray-600 mb-8">è«‹ç™»å…¥ä»¥å­˜å–æ‚¨çš„é›²ç«¯è¡Œç¨‹</p>
        
        <button id="google-login-btn" class="flex items-center gap-3 px-6 py-3 bg-white border border-gray-300 rounded-lg shadow-md hover:bg-gray-50 transition font-medium text-gray-700">
           <img src="https://www.google.com/favicon.ico" width="24" height="24" alt="Google">
            ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ (è·³è½‰æ¨¡å¼)
        </button>

        <!-- ç‹€æ…‹é¡¯ç¤ºèˆ‡é™¤éŒ¯å€ -->
        <div class="mt-8 w-full max-w-md px-4">
            <p id="login-status" class="text-center text-sm font-bold text-gray-500 mb-2">ç­‰å¾…æ“ä½œ...</p>
            <div id="debug-console" class="bg-gray-800 text-green-400 text-xs p-3 rounded-lg shadow-inner w-full opacity-80">
                <div>[System] Ready. Waiting for user...</div>
            </div>
        </div>

        <button id="retry-btn" class="mt-4 text-sm text-blue-500 underline hidden" onclick="location.reload()">é‡æ–°æ•´ç†é é¢</button>
    </div>

    <!-- ä¸»å®¹å™¨ (ç™»å…¥å¾Œé¡¯ç¤º) -->
    <div id="app-container" class="max-w-6xl mx-auto p-4 md:p-6 hidden">
        
        <!-- æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œ -->
        <header class="mb-8 bg-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center relative gap-4">
            <div class="w-full md:w-auto flex justify-start gap-2">
                 <!-- é›²ç«¯å­˜æª”æŒ‰éˆ• -->
                <button onclick="window.openCloudManager()" class="flex items-center gap-2 px-4 py-2 bg-amber-100 text-amber-800 rounded-lg hover:bg-amber-200 transition font-medium border border-amber-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    é›²ç«¯è¡Œç¨‹åº«
                </button>
            </div>
            
            <div class="flex flex-col items-center">
                <h1 class="text-2xl md:text-3xl font-extrabold text-blue-700 tracking-tight flex items-center justify-center">
                    Plan-T (Cloud)
                </h1>
                <span id="sync-status" class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-gray-300"></span> æº–å‚™å°±ç·’
                </span>
            </div>
            
            <div class="w-full md:w-auto flex justify-end items-center gap-3">
                <!-- ä½¿ç”¨è€…è³‡è¨Šèˆ‡ç™»å‡º -->
                <div class="flex items-center gap-2">
                    <img id="user-avatar" src="" alt="User" class="w-8 h-8 rounded-full border border-gray-200 hidden">
                    <span id="user-name" class="text-sm font-medium text-gray-700 hidden md:inline"></span>
                    <button id="logout-btn" class="text-xs text-red-500 hover:text-red-700 border border-red-200 px-2 py-1 rounded">ç™»å‡º</button>
                </div>
            </div>
        </header>

        <!-- è¨Šæ¯/åŠ è¼‰æŒ‡ç¤ºå™¨ -->
        <div id="message-area" class="text-center mb-4 hidden"></div>

        <!-- è¼¸å…¥è¡¨å–®å€å¡Š (å»ºç«‹æ–°è¡Œç¨‹) -->
        <section id="input-form-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">å»ºç«‹æ–°è¡Œç¨‹è¨ˆç•«</h2>
            <form id="plan-form" class="space-y-4">
                <div>
                    <label for="tripName" class="block text-sm font-medium text-gray-700">è¨ˆç•«åç¨±</label>
                    <input type="text" id="tripName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="è¼¸å…¥è¡Œç¨‹æ¨™é¡Œï¼Œä¾‹å¦‚ï¼šæ—¥æœ¬é—œè¥¿äº”æ—¥éŠ">
                </div>
                
                <div class="grid grid-cols-2 gap-4 relative">
                    <!-- èµ·å§‹æ—¥æœŸ -->
                    <div>
                        <label for="startDateDisplay" class="block text-sm font-medium text-gray-700">èµ·å§‹æ—¥æœŸ</label>
                        <div class="relative mt-1">
                            <input type="text" id="startDateDisplay" required class="block w-full rounded-l-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white" placeholder="YYYY/MM/DD" onchange="handleManualDateInput(this.value, 'startDate')">
                            <input type="hidden" id="startDate" name="startDate">
                            <button type="button" class="absolute inset-y-0 right-0 px-3 bg-blue-100 rounded-r-lg border border-l-0 border-gray-300 hover:bg-blue-200 z-10" onclick="showCalendar('startDate')">ğŸ“…</button>
                        </div>
                    </div>
                    <!-- çµæŸæ—¥æœŸ -->
                    <div>
                        <label for="endDateDisplay" class="block text-sm font-medium text-gray-700">çµæŸæ—¥æœŸ</label>
                        <div class="relative mt-1">
                            <input type="text" id="endDateDisplay" required class="block w-full rounded-l-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white" placeholder="YYYY/MM/DD" onchange="handleManualDateInput(this.value, 'endDate')">
                            <input type="hidden" id="endDate" name="endDate">
                            <button type="button" class="absolute inset-y-0 right-0 px-3 bg-blue-100 rounded-r-lg border border-l-0 border-gray-300 hover:bg-blue-200 z-10" onclick="showCalendar('endDate')">ğŸ“…</button>
                        </div>
                    </div>
                    
                    <!-- æ—¥æ›†çµ„ä»¶ -->
                    <div id="calendar-popover" class="absolute top-full left-0 mt-2 w-full z-20 bg-white border border-gray-200 rounded-xl shadow-2xl p-4 hidden md:w-80 md:left-1/2 md:-translate-x-1/2">
                        <div id="calendar-header" class="flex justify-between items-center mb-4">
                            <button type="button" class="p-2 hover:bg-gray-100 rounded-full" onclick="changeMonth(-1)">â—€</button>
                            <span id="current-month-year" class="font-semibold text-lg"></span>
                            <button type="button" class="p-2 hover:bg-gray-100 rounded-full" onclick="changeMonth(1)">â–¶</button>
                        </div>
                        <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center"></div>
                    </div>
                </div>

                <div class="flex gap-4 pt-2">
                    <button type="submit" id="generate-button" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                        é–‹å§‹è¦åŠƒ
                    </button>
                </div>
            </form>
        </section>

        <!-- è¡Œç¨‹è¡¨é¡¯ç¤ºå€å¡Š -->
        <section id="itinerary-table-section" class="hidden">
            
            <!-- å·¥å…·åˆ— -->
            <div class="mb-4 flex flex-wrap justify-between items-center gap-2 bg-white p-3 rounded-xl shadow-sm border border-gray-100 no-print">
                <div class="flex gap-2 items-center">
                    <!-- åˆ†äº«æŒ‰éˆ• -->
                    <button onclick="window.openShareModal()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-purple-500 rounded hover:bg-purple-600 shadow-sm transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                        é‚€è«‹å”ä½œè€…
                    </button>
                    <span id="collaborators-count" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full hidden"></span>
                </div>

                <div class="flex gap-2">
                    <button onclick="exportToJPG()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-indigo-500 rounded hover:bg-indigo-600">JPG</button>
                    <button onclick="exportToCSV()" class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700">CSV</button>
                </div>
            </div>

            <div id="capture-area" class="bg-white rounded-xl shadow-lg p-1">
                <h2 id="current-trip-name" class="text-2xl font-bold my-4 text-gray-800 text-center"></h2>
                <!-- è¡¨æ ¼ -->
                <div class="overflow-x-auto pb-4">
                    <table class="min-w-full divide-y divide-gray-200 table-fixed border-b border-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th rowspan="2" class="w-28 px-2 py-3 text-center text-xs font-bold text-gray-500 uppercase border-r border-gray-200 align-bottom sticky-col bg-blue-50">Date</th>
                                <th rowspan="2" class="w-1/4 px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom">Location</th>
                                <th rowspan="2" class="w-24 px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">Time</th>
                                <th colspan="2" class="w-48 px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase border-b border-gray-200 thick-border-left">Cost</th>
                                <th rowspan="2" class="w-16 px-3 py-3 text-center text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">OK?</th>
                                <th rowspan="2" class="px-3 py-3 text-left text-xs font-bold text-gray-500 uppercase align-bottom thick-border-left">Remark</th>
                            </tr>
                            <tr>
                                <th class="w-24 cost-subheader-cell editable-cell thick-border-left" contenteditable="true" data-field="costHeader1" data-header="true">(NTD)</th>
                                <th class="w-24 cost-subheader-cell editable-cell" contenteditable="true" data-field="costHeader2" data-header="true">(å††)</th>
                            </tr>
                        </thead>
                        <tbody id="itinerary-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <div class="mt-6 text-center no-print">
                 <button onclick="window.closeCurrentTrip()" class="py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">é—œé–‰ç›®å‰è¡Œç¨‹ (å›åˆ°ä¸»é¸å–®)</button>
            </div>
        </section>

        <!-- åŠ è¼‰å‹•ç•« -->
        <div id="loading-spinner" class="hidden text-center p-8 fixed inset-0 bg-white/80 z-[60] flex flex-col justify-center items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p id="loading-text" class="mt-3 text-blue-600 font-medium">è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- é›²ç«¯å­˜æª”åˆ—è¡¨ Modal -->
    <div id="cloud-manager-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">é›²ç«¯è¡Œç¨‹åº«</h3>
                <button onclick="window.closeCloudManager()" class="text-gray-500 hover:text-gray-700">âœ•</button>
            </div>
            <div class="p-4 bg-blue-50 text-sm text-gray-600">
                é»æ“Šä¸‹æ–¹åˆ—è¡¨é–‹å•Ÿè¡Œç¨‹ã€‚æ‚¨å¯ä»¥èˆ‡æœ‹å‹åˆ†äº«è¡Œç¨‹ ID æˆ– Email ä¾†å”ä½œã€‚
            </div>
            <div id="cloud-list" class="flex-grow overflow-y-auto p-4 space-y-3 bg-gray-50 min-h-[200px]">
                <p class="text-center text-gray-400 mt-10">è¼‰å…¥ä¸­...</p>
            </div>
             <div class="p-4 border-t border-gray-200 bg-white">
                <button onclick="window.closeCloudManager(); document.getElementById('input-form-section').classList.remove('hidden');" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å»ºç«‹æ–°è¡Œç¨‹</button>
            </div>
        </div>
    </div>

    <!-- åˆ†äº« Modal -->
    <div id="share-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex justify-center items-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">é‚€è«‹å”ä½œè€…</h3>
            <p class="text-sm text-gray-600 mb-4">è¼¸å…¥å°æ–¹çš„ Google Emailï¼Œä»–å°±èƒ½åœ¨ã€Œé›²ç«¯è¡Œç¨‹åº«ã€çœ‹åˆ°ä¸¦ç·¨è¼¯æ­¤è¡Œç¨‹ã€‚</p>
            
            <div class="flex gap-2 mb-4">
                <input type="email" id="share-email-input" class="flex-1 border border-gray-300 rounded-lg p-2" placeholder="friend@gmail.com">
                <button onclick="window.addCollaborator()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">æ–°å¢</button>
            </div>

            <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2">ç›®å‰çš„æˆå“¡ï¼š</h4>
                <ul id="collaborators-list" class="text-sm text-gray-600 space-y-1"></ul>
            </div>

            <div class="text-right">
                <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- é¡åˆ¥/ç¢ºèª Popover -->
    <div id="global-category-popover" class="hidden category-popover-menu w-40 bg-white border border-gray-200 rounded-lg shadow-xl p-1 z-50"></div>
    <div id="global-confirmation-popover" class="hidden confirmation-popover-menu w-32 bg-white border border-gray-200 rounded-lg shadow-xl p-1 z-50"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, arrayRemove, collection, addDoc, query, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCQtd1FzIi79nzxBoYUwFMErzSqQ1ql6H8",
            authDomain: "plan-t-18056.firebaseapp.com",
            projectId: "plan-t-18056",
            storageBucket: "plan-t-18056.firebasestorage.app",
            messagingSenderId: "303000679644",
            appId: "1:303000679644:web:d37e006d0eb22921a03019",
            measurementId: "G-GFB5L5LHW5"
        };

        const logDebug = (msg) => {
            const consoleEl = document.getElementById('debug-console');
            const p = document.createElement('div');
            p.textContent = `> ${msg}`;
            consoleEl.appendChild(p);
            consoleEl.scrollTop = consoleEl.scrollHeight;
            console.log(msg);
        };

        // Initialize Firebase
        logDebug("Initializing Firebase...");
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // é—œéµä¿®æ­£ï¼šä¸€å®šè¦ç”¨ async/await + æ”¾åœ¨ signInWithRedirect å‰é¢ï¼Œä¸”ä¸èƒ½è·³éï¼
logDebug("Setting persistence to LOCAL (å¿…é ˆåœ¨ redirect å‰å®Œæˆ)...");
try {
    await setPersistence(auth, browserLocalPersistence);
    logDebug("Persistence å·²æˆåŠŸè¨­å®šç‚º LOCAL");
} catch (error) {
    logDebug("Persistence è¨­å®šå¤±æ•—: " + error.message);
    alert("ç€è¦½å™¨è¨­å®šå•é¡Œï¼Œè«‹é—œé–‰ç¬¬ä¸‰æ–¹ Cookie é˜»æ“‹æˆ–æ›ç€è¦½å™¨");
}
                // --- Global State ---
        let currentUser = null;
        let currentTripId = null;
        let currentTripData = null;
        let unsubscribeTrip = null; // Listener detacher

        // --- Auth Logic ---
        const loginOverlay = document.getElementById('login-overlay');
        const appContainer = document.getElementById('app-container');
        const loginStatus = document.getElementById('login-status');
        const retryBtn = document.getElementById('retry-btn');

        // Check for redirect result on page load using ASYNC/AWAIT
        (async () => {
            try {
                logDebug("Checking redirect result...");
                const result = await getRedirectResult(auth);
                if (result) {
                    logDebug("Redirect result found! User: " + result.user.email);
                    loginStatus.textContent = `æ­¡è¿å›ä¾†ï¼Œ${result.user.displayName}ï¼`;
                    loginStatus.classList.remove('hidden');
                    loginStatus.className = "mt-4 text-sm text-green-600 font-bold";
                } else {
                    logDebug("No redirect result found (Normal page load).");
                }
            } catch (error) {
                logDebug("Redirect Error: " + error.code + " - " + error.message);
            }
        })();

        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                logDebug("Start login process...");
                loginStatus.textContent = "æ­£åœ¨è½‰å‘ Google ç™»å…¥é é¢...";
                loginStatus.classList.remove('hidden');
                loginStatus.className = "mt-4 text-sm text-gray-500 font-bold";
                retryBtn.classList.add('hidden');
                
                // USE REDIRECT
                logDebug("Calling signInWithRedirect...");
                await signInWithRedirect(auth, provider);
                
            } catch (error) {
                logDebug("Login Trigger Error: " + error.message);
                loginStatus.textContent = "ç™»å…¥å¤±æ•—: " + error.message;
                loginStatus.className = "mt-4 text-sm text-red-600 font-bold block";
                retryBtn.classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
             if(unsubscribeTrip) unsubscribeTrip(); // Stop listening
             signOut(auth);
             location.reload();
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                logDebug("Auth State Changed: LOGGED IN as " + user.email);
                
                currentUser = user;
                document.getElementById('login-overlay').remove();
                loginOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Update Header UI
                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('user-avatar').src = user.photoURL;
                document.getElementById('user-avatar').classList.remove('hidden');

                // Load initial view
                window.openCloudManager();
            } else {
                logDebug("Auth State Changed: LOGGED OUT");
                currentUser = null;
            }
        });

        // --- Firestore Logic ---

        // 1. Create New Trip
        const createNewTrip = async (tripData) => {
            try {
                // IMPORTANT: Use the /artifacts/{appId}/public/data/trips path for collaborative public data
                const appId = "default-app-id"; 
                const collectionPath = `artifacts/${appId}/public/data/trips`;

                const docRef = await addDoc(collection(db, collectionPath), {
                    ...tripData,
                    ownerId: currentUser.uid,
                    ownerName: currentUser.displayName,
                    createdAt: new Date().toISOString(),
                    collaborators: [currentUser.email], // Add self as collaborator
                    headerData: { costHeader1: '(NTD)', costHeader2: '(å††)' }
                });
                return docRef.id;
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("å»ºç«‹å¤±æ•—ï¼š" + e.message);
            }
        };

        // 2. Load Trip (Real-time)
        window.loadCloudTrip = (tripId) => {
            if (unsubscribeTrip) unsubscribeTrip(); // Detach previous listener
            currentTripId = tripId;
            
            window.closeCloudManager();
            document.getElementById('loading-spinner').classList.remove('hidden');

            const appId = "default-app-id"; 
            const docPath = `artifacts/${appId}/public/data/trips/${tripId}`;
            const tripRef = doc(db, docPath);
            
            unsubscribeTrip = onSnapshot(tripRef, (doc) => {
                document.getElementById('loading-spinner').classList.add('hidden');
                if (doc.exists()) {
                    currentTripData = doc.data();
                    renderItineraryTable(currentTripData.itinerary || [], currentTripData.tripName);
                    
                    // Update header fields
                    const h1 = document.querySelector('[data-field="costHeader1"]');
                    const h2 = document.querySelector('[data-field="costHeader2"]');
                    if(h1 && currentTripData.headerData) h1.textContent = currentTripData.headerData.costHeader1;
                    if(h2 && currentTripData.headerData) h2.textContent = currentTripData.headerData.costHeader2;

                    updateSyncStatus("å·²åŒæ­¥");
                } else {
                    alert("æ­¤è¡Œç¨‹å·²è¢«åˆªé™¤"); 
                    window.closeCurrentTrip();
                }
            }, (error) => {
                console.error(error);
                alert("è®€å–å¤±æ•—ï¼Œæ‚¨å¯èƒ½æ²’æœ‰æ¬Šé™ã€‚"); 
                window.closeCurrentTrip();
            });
        };

        // 3. Update Trip (Single Field or Full Itinerary)
        const updateCloudTrip = async (newData, merge = true) => {
            if (!currentTripId) return;
            updateSyncStatus("åŒæ­¥ä¸­...", "pending");
            try {
                const appId = "default-app-id";
                const docPath = `artifacts/${appId}/public/data/trips/${currentTripId}`;
                const tripRef = doc(db, docPath);
                await updateDoc(tripRef, newData);
                updateSyncStatus("å·²å„²å­˜");
            } catch (e) {
                console.error(e);
                updateSyncStatus("å„²å­˜å¤±æ•—", "error");
            }
        };

        // 4. List User's Trips
        window.openCloudManager = async () => {
            const listContainer = document.getElementById('cloud-list');
            const modal = document.getElementById('cloud-manager-modal');
            modal.classList.remove('hidden');
            listContainer.innerHTML = '<p class="text-center text-gray-400 mt-4">è¼‰å…¥ä¸­...</p>';

            try {
                const appId = "default-app-id"; 
                const collectionPath = `artifacts/${appId}/public/data/trips`;

                // Query trips where user is owner OR collaborator
                const q = query(collection(db, collectionPath), where("collaborators", "array-contains", currentUser.email));
                const querySnapshot = await getDocs(q);

                listContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 mt-4">æ‚¨ç›®å‰æ²’æœ‰é›²ç«¯è¡Œç¨‹ã€‚</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center hover:bg-blue-50 cursor-pointer transition';
                    item.onclick = (e) => {
                        // Prevent triggering if delete button clicked
                        if(e.target.closest('.delete-btn')) return;
                        window.loadCloudTrip(doc.id);
                    };
                    
                    const isOwner = data.ownerId === currentUser.uid;
                    const deleteBtn = isOwner ? `<button class="delete-btn ml-2 p-2 text-red-400 hover:text-red-600 z-10" onclick="window.deleteCloudTrip('${doc.id}')">ğŸ—‘ï¸</button>` : '';

                    item.innerHTML = `
                        <div class="overflow-hidden">
                            <div class="font-bold text-gray-800 truncate">${data.tripName}</div>
                            <div class="text-xs text-gray-500">
                                ${data.startDate} ~ ${data.endDate} <br>
                                æ“æœ‰è€…: ${isOwner ? 'æˆ‘' : data.ownerName}
                            </div>
                        </div>
                        ${deleteBtn}
                    `;
                    listContainer.appendChild(item);
                });

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<p class="text-red-500 text-center">è¼‰å…¥å¤±æ•—</p>';
            }
        };

        window.closeCloudManager = () => {
            document.getElementById('cloud-manager-modal').classList.add('hidden');
        };

        window.deleteCloudTrip = async (id) => {
            if(confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤é›²ç«¯è¡Œç¨‹å—ï¼Ÿ")) { 
                const appId = "default-app-id"; 
                const docPath = `artifacts/${appId}/public/data/trips/${id}`;
                await deleteDoc(doc(db, docPath));
                window.openCloudManager(); // Refresh list
            }
        };

        window.closeCurrentTrip = () => {
            if (unsubscribeTrip) unsubscribeTrip();
            currentTripId = null;
            document.getElementById('itinerary-table-section').classList.add('hidden');
            document.getElementById('input-form-section').classList.add('hidden');
            window.openCloudManager();
        };

        // --- Collaboration Logic ---
        window.openShareModal = () => {
            document.getElementById('share-modal').classList.remove('hidden');
            const list = document.getElementById('collaborators-list');
            list.innerHTML = '';
            if(currentTripData && currentTripData.collaborators) {
                currentTripData.collaborators.forEach(email => {
                    const li = document.createElement('li');
                    li.textContent = email;
                    if(email === currentTripData.ownerName || (currentTripData.ownerId === currentUser.uid && email !== currentUser.email)) {
                         // Add remove button logic if needed later
                    }
                    list.appendChild(li);
                });
            }
        };

        window.addCollaborator = async () => {
            const email = document.getElementById('share-email-input').value.trim();
            if(!email) return;
            if(!currentTripId) return;

            try {
                const appId = "default-app-id"; 
                const docPath = `artifacts/${appId}/public/data/trips/${currentTripId}`;

                await updateDoc(doc(db, docPath), {
                    collaborators: arrayUnion(email)
                });
                document.getElementById('share-email-input').value = '';
                alert(`å·²é‚€è«‹ ${email}`); 
                window.openShareModal(); // Refresh list
            } catch(e) {
                alert("é‚€è«‹å¤±æ•—");
            }
        };

        // --- UI & Helper Functions (Adapted) ---

        const updateSyncStatus = (text, type='success') => {
            const el = document.getElementById('sync-status');
            let color = type === 'success' ? 'bg-green-400' : (type === 'pending' ? 'bg-yellow-400' : 'bg-red-400');
            el.innerHTML = `<span class="w-2 h-2 rounded-full ${color} animate-pulse"></span> ${text}`;
        };

        // Date Helpers
        const dateToIsoString = (date) => date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
        const dateToDisplayString = (date) => `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        const isoStringToDate = (iso) => { if(!iso) return null; const p=iso.split(/[-/]/).map(Number); return new Date(p[0],p[1]-1,p[2]); };

        // Form Submission (Generate New Trip)
        document.getElementById('plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const tripName = document.getElementById('tripName').value.trim();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            // Use custom modal instead of alert()
            if(!tripName || !start || !end) return alert("è«‹å¡«å¯«å®Œæ•´"); 

            // Generate Empty Itinerary
            const itinerary = [];
            let curr = isoStringToDate(start);
            const last = isoStringToDate(end);
            let idx = 0;
            while(curr <= last) {
                 itinerary.push({
                    date: dateToIsoString(curr),
                    dayNum: idx + 1,
                    dayOfWeek: ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'][curr.getDay()],
                    location: "", departureTime: "", cost1: "", cost2: "", confirmation: "TBD", remark: "", category: ""
                 });
                 curr.setDate(curr.getDate()+1);
                 idx++;
            }

            // Create in Cloud
            document.getElementById('loading-spinner').classList.remove('hidden');
            const newId = await createNewTrip({ tripName, startDate: start, endDate: end, itinerary });
            
            // Switch to Edit Mode
            if(newId) window.loadCloudTrip(newId);
        });

        // Cell Editing Logic (Auto-save to Cloud)
        window.handleCellEdit = (e) => {
            if(!currentTripId || !currentTripData) return;
            const cell = e.target;
            const field = cell.dataset.field;
            const val = cell.textContent.trim();

            if (cell.dataset.header === 'true') {
                 // Update Header
                 const newHeader = { ...currentTripData.headerData, [field]: val };
                 updateCloudTrip({ headerData: newHeader });
            } else {
                 // Update Itinerary Row
                 const idx = parseInt(cell.dataset.index);
                 const newItinerary = [...currentTripData.itinerary];
                 newItinerary[idx][field] = val;
                 updateCloudTrip({ itinerary: newItinerary });
            }
        };
        
        // Category & Confirmation Logic (Auto-save)
        window.selectCategory = (idx, cat) => {
             const newItinerary = [...currentTripData.itinerary];
             newItinerary[idx].category = cat;
             updateCloudTrip({ itinerary: newItinerary });
             document.getElementById('global-category-popover').classList.add('hidden');
        };

        window.selectConfirmation = (idx, status) => {
             const newItinerary = [...currentTripData.itinerary];
             newItinerary[idx].confirmation = status;
             updateCloudTrip({ itinerary: newItinerary });
             document.getElementById('global-confirmation-popover').classList.add('hidden');
        };
        
        window.insertRow = (idx, pos) => {
             const newItinerary = [...currentTripData.itinerary];
             const ref = newItinerary[idx];
             const item = { ...ref, location:"", departureTime:"", cost1:"", cost2:"", confirmation:"TBD", remark:"", category:"" };
             if(pos === 'before') newItinerary.splice(idx, 0, item);
             else newItinerary.splice(idx+1, 0, item);
             updateCloudTrip({ itinerary: newItinerary });
        };
        
        window.deleteRow = (idx) => {
            if(confirm("åˆªé™¤æ­¤åˆ—?")) { 
                const newItinerary = [...currentTripData.itinerary];
                newItinerary.splice(idx, 1);
                updateCloudTrip({ itinerary: newItinerary });
            }
        };

        // --- Render Logic (Simplified from original) ---
        const CATEGORY_MAP = { "é‡é»": { class: "bg-lime-200" }, "äº¤é€š": { class: "bg-yellow-100" }, "æ´»å‹•å€": { class: "bg-green-100" }, "äº‹ä»¶": { class: "bg-blue-100" } };
        const CONFIRMATION_MAP = { "O": { symbol: "âœ”", class: "bg-green-500 text-white" }, "X": { symbol: "âœ˜", class: "bg-red-500 text-white" }, "TBD": { symbol: "â–³", class: "bg-yellow-400 text-gray-800" } };

        const renderItineraryTable = (itinerary, tripName) => {
            document.getElementById('input-form-section').classList.add('hidden');
            document.getElementById('itinerary-table-section').classList.remove('hidden');
            document.getElementById('current-trip-name').textContent = tripName;

            const tbody = document.getElementById('itinerary-body');
            tbody.innerHTML = '';
            
            const processedDates = new Set();
            const rowspans = {};
            itinerary.forEach(i => { if(!rowspans[i.date]) rowspans[i.date]=0; rowspans[i.date]++; });

            itinerary.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                if (!processedDates.has(item.date) && index > 0) tr.classList.add('new-day-border-top');
                
                // Date Column
                if (!processedDates.has(item.date)) {
                    tr.innerHTML += `<td rowspan="${rowspans[item.date]}" class="date-cell px-2 py-4 text-sm font-medium text-center border-r border-gray-200 bg-white sticky-col">${item.date.slice(5)}<br>${item.dayOfWeek}<br>(Day ${item.dayNum})</td>`;
                    processedDates.add(item.date);
                }

                const catClass = CATEGORY_MAP[item.category]?.class || 'bg-white';
                const conf = CONFIRMATION_MAP[item.confirmation] || CONFIRMATION_MAP["TBD"];

                // Location & Controls
                tr.innerHTML += `
                    <td class="px-3 py-4 text-sm relative location-cell-wrapper group">
                         <div class="absolute left-1 top-1/2 -translate-y-1/2 flex flex-col gap-1 row-controls z-10">
                            <button onclick="window.insertRow(${index}, 'before')" class="text-blue-600 bg-blue-100 p-1 rounded">â–²</button>
                            <button onclick="window.insertRow(${index}, 'after')" class="text-blue-600 bg-blue-100 p-1 rounded">â–¼</button>
                        </div>
                        <div class="flex items-start">
                            <div class="editable-cell flex-grow pl-6 p-2 border border-gray-300 rounded min-h-[2.5rem] ${catClass}" contenteditable="true" data-field="location" data-index="${index}">${item.location}</div>
                            <button onclick="window.showCategoryMenu(${index}, this)" class="ml-1 p-1 bg-gray-100 rounded-full hover:bg-blue-200">ğŸ·ï¸</button>
                            <button onclick="window.deleteRow(${index})" class="ml-1 p-1 bg-red-50 text-red-400 rounded-full hover:bg-red-200">âœ•</button>
                        </div>
                    </td>
                    <td class="px-3 py-4 text-sm thick-border-left"><div class="editable-cell p-2 border rounded bg-white" contenteditable="true" data-field="departureTime" data-index="${index}">${item.departureTime}</div></td>
                    <td class="px-3 py-4 text-sm w-24 thick-border-left"><div class="editable-cell p-2 border rounded bg-white" contenteditable="true" data-field="cost1" data-index="${index}">${item.cost1}</div></td>
                    <td class="px-3 py-4 text-sm w-24"><div class="editable-cell p-2 border rounded bg-white" contenteditable="true" data-field="cost2" data-index="${index}">${item.cost2}</div></td>
                    <td class="px-3 py-4 text-center w-16 thick-border-left"><button onclick="window.showConfirmationMenu(${index}, this)" class="w-full h-8 font-bold rounded ${conf.class}">${conf.symbol}</button></td>
                    <td class="px-3 py-4 text-sm thick-border-left"><div class="editable-cell p-2 border rounded bg-white" contenteditable="true" data-field="remark" data-index="${index}">${item.remark}</div></td>
                `;
                tbody.appendChild(tr);
            });

            // Re-attach listeners
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('blur', window.handleCellEdit);
            });
        };

        // --- Popover UI Helpers (Simplified) ---
        window.showCategoryMenu = (idx, btn) => {
            const pop = document.getElementById('global-category-popover');
            pop.innerHTML = Object.entries(CATEGORY_MAP).map(([k,v]) => `<button onclick="window.selectCategory(${idx}, '${k}')" class="w-full text-left px-4 py-2 hover:opacity-80 ${v.class}">${k}</button>`).join('') + `<button onclick="window.selectCategory(${idx}, '')" class="w-full text-left px-4 py-2 text-red-500">æ¸…é™¤</button>`;
            const rect = btn.getBoundingClientRect();
            pop.style.top = (rect.top + window.scrollY) + 'px'; pop.style.left = (rect.right + 10) + 'px';
            pop.classList.remove('hidden');
        };

        window.showConfirmationMenu = (idx, btn) => {
            const pop = document.getElementById('global-confirmation-popover');
            pop.innerHTML = Object.entries(CONFIRMATION_MAP).map(([k,v]) => `<button onclick="window.selectConfirmation(${idx}, '${k}')" class="w-full text-left px-4 py-2 hover:bg-gray-100 ${v.class}">${v.symbol} ${k}</button>`).join('');
            const rect = btn.getBoundingClientRect();
            pop.style.top = (rect.top + window.scrollY) + 'px'; pop.style.left = (rect.left - 130) + 'px';
            pop.classList.remove('hidden');
        };
        
        // Close popovers on click outside
        document.addEventListener('click', (e) => {
             if(!e.target.closest('button')) {
                 document.getElementById('global-category-popover').classList.add('hidden');
                 document.getElementById('global-confirmation-popover').classList.add('hidden');
             }
        });

        // Calendar Logic (Minimalist)
        window.handleManualDateInput = (val, id) => { document.getElementById(id).value = val.replace(/\//g,'-'); };
        window.showCalendar = (id) => {
             // Use custom modal instead of prompt()
             const val = prompt("è«‹è¼¸å…¥æ—¥æœŸ (YYYY-MM-DD):", document.getElementById(id).value || new Date().toISOString().split('T')[0]);
             if(val) { document.getElementById(id).value = val; document.getElementById(id+'Display').value = val; }
        };

        // Export (Keep original functionality mostly)
        window.exportToJPG = () => { 
            html2canvas(document.getElementById("capture-area"), { useCORS: true }).then(canvas => {
                const a = document.createElement("a"); a.href = canvas.toDataURL("image/jpeg"); a.download = "plan.jpg"; a.click();
            });
        };
        // Use custom modal instead of alert()
        window.exportToCSV = () => { alert("CSV åŠŸèƒ½åœ¨é›²ç«¯ç‰ˆä¸­æš«æ™‚éš±è— (å¯ä¾éœ€æ±‚åŠ å›)"); }; 

    </script>
</body>
</html>






